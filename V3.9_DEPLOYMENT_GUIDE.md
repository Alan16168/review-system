# V3.9 部署指南 - 团队协作复盘功能

## 📦 本次更新内容

### 核心功能
✅ **团队协作复盘**：多人并列答题，每个问题显示所有成员的答案  
✅ **权限控制**：成员只能编辑自己的答案，创建者可删除他人答案  
✅ **自动保存**：答案修改后自动保存，无需手动提交  
✅ **完成状态**：显示每个成员的完成进度（已完成X/9题）  
✅ **手动刷新**：支持刷新页面查看最新答案  

### 技术变更
- **数据库**：新增 `team_review_answers` 表
- **后端API**：3个新接口（GET team-answers, PUT my-answer, DELETE answer）
- **前端UI**：新增团队协作答题界面
- **国际化**：17个新翻译键（中英双语）

---

## 🚀 部署步骤

### 步骤 1：配置 Cloudflare API Key（如尚未配置）

在沙盒环境中运行：
```bash
# 调用 setup_cloudflare_api_key 工具配置认证
```

如果失败，请前往 **Deploy 标签页**配置 Cloudflare API Key。

---

### 步骤 2：应用生产数据库迁移

```bash
cd /home/user/webapp

# 应用新的数据库迁移（创建 team_review_answers 表）
npx wrangler d1 migrations apply review-system-production
```

**注意**：
- 这会在生产数据库中创建新表
- 迁移是幂等的，多次运行不会有问题
- 如果超时，可以直接进行下一步，部署时会自动应用

---

### 步骤 3：构建项目

```bash
cd /home/user/webapp

# 构建生产版本
npm run build
```

**预期输出**：
```
vite v6.3.6 building SSR bundle for production...
transforming...
✓ 130 modules transformed.
rendering chunks...
dist/_worker.js  142.90 kB
✓ built in 1.39s
```

---

### 步骤 4：部署到 Cloudflare Pages

```bash
cd /home/user/webapp

# 部署到生产环境
npx wrangler pages deploy dist --project-name review-system
```

**预期输出**：
```
✨ Success! Uploaded 1 file
✨ Deployment complete! Take a peek over at https://xxx.review-system.pages.dev
```

---

### 步骤 5：验证部署

#### 5.1 检查网站访问
访问：https://review-system.pages.dev

应该能够：
- 正常登录
- 查看复盘列表
- 创建团队复盘

#### 5.2 测试团队协作功能

**测试步骤**：
1. 使用用户A登录（如 admin@review.com）
2. 创建一个团队复盘（选择已有团队）
3. 点击"查看详情" → 点击"查看团队答案"
4. 填写自己的答案，应该自动保存
5. 使用用户B登录（同一团队成员）
6. 打开相同的复盘 → 点击"查看团队答案"
7. 应该能看到用户A的答案（只读）
8. 填写自己的答案
9. 用户A刷新页面，应该能看到用户B的答案

#### 5.3 测试API接口

```bash
# 登录获取 token
TOKEN=$(curl -s -X POST https://review-system.pages.dev/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@review.com","password":"admin123"}' | jq -r '.token')

# 获取复盘列表
curl -s -X GET https://review-system.pages.dev/api/reviews \
  -H "Authorization: Bearer $TOKEN" | jq '.reviews[0]'

# 获取团队答案（假设复盘ID为1）
curl -s -X GET https://review-system.pages.dev/api/reviews/1/team-answers \
  -H "Authorization: Bearer $TOKEN" | jq '.'

# 保存答案
curl -s -X PUT https://review-system.pages.dev/api/reviews/1/my-answer/1 \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"answer":"这是我的测试答案"}' | jq '.'
```

---

## 🗂️ 文件变更清单

### 新增文件
- `migrations/0007_add_team_review_answers.sql` - 数据库迁移文件
- `V3.9_TEAM_COLLABORATION_FEATURE.md` - 技术文档
- `V3.9_DEPLOYMENT_GUIDE.md` - 本部署指南

### 修改文件
- `src/utils/db.ts` - 新增5个数据库工具函数
- `src/routes/reviews.ts` - 新增3个API路由
- `public/static/app.js` - 新增3个前端函数
- `public/static/i18n.js` - 新增17个翻译键
- `README.md` - 更新文档

---

## 📊 数据库变更详情

### 新表：team_review_answers

```sql
CREATE TABLE IF NOT EXISTS team_review_answers (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  review_id INTEGER NOT NULL,
  user_id INTEGER NOT NULL,
  question_number INTEGER NOT NULL CHECK (question_number >= 1 AND question_number <= 9),
  answer TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (review_id) REFERENCES reviews(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE(review_id, user_id, question_number)
);
```

**索引**：
- `idx_team_review_answers_review_id`
- `idx_team_review_answers_user_id`
- `idx_team_review_answers_question`

**特性**：
- 每个用户对每个问题只能有一个答案（UNIQUE 约束）
- 级联删除（复盘或用户删除时，答案自动删除）

---

## 🔍 故障排查

### 问题 1：数据库迁移超时

**症状**：`npx wrangler d1 migrations apply` 命令超时

**解决方案**：
1. 直接跳过迁移命令
2. 执行 `npm run build` 构建项目
3. 执行 `npx wrangler pages deploy` 部署
4. 部署时会自动应用迁移

---

### 问题 2：团队答案界面显示空白

**可能原因**：
- 复盘不是团队复盘
- 用户不是团队成员

**检查步骤**：
1. 确认复盘有 `team_id`（在复盘详情中查看）
2. 确认当前用户是团队成员
3. 查看浏览器控制台是否有错误信息

---

### 问题 3：自动保存不生效

**可能原因**：
- 网络问题
- API 认证失败

**检查步骤**：
1. 打开浏览器开发者工具 → Network 标签
2. 修改答案后查看是否有 PUT 请求发出
3. 查看请求响应状态码（应为 200）

---

### 问题 4：看不到其他成员的答案

**可能原因**：
- 其他成员还没有填写答案
- 需要刷新页面

**解决方案**：
1. 点击页面右上角的"刷新"按钮
2. 或按 F5 / Ctrl+R 刷新整个页面

---

## 📝 回滚方案

如果部署后发现严重问题，可以回滚到 V3.8：

### 方案 1：回滚代码

```bash
cd /home/user/webapp

# 回退到上一个 commit
git reset --hard HEAD~1

# 重新构建和部署
npm run build
npx wrangler pages deploy dist --project-name review-system
```

### 方案 2：删除新表（不推荐）

```bash
# 只在绝对必要时使用
npx wrangler d1 execute review-system-production \
  --command "DROP TABLE IF EXISTS team_review_answers"
```

---

## 🎯 下一步建议

### 功能增强
1. **实时更新**：使用 WebSocket 实现实时答案同步
2. **评论功能**：允许成员对他人的答案进行评论
3. **答案历史**：保存答案的修改历史
4. **导出功能**：导出团队所有答案为 PDF

### 性能优化
1. **缓存策略**：在前端缓存团队答案，减少 API 调用
2. **分页加载**：如果团队成员很多，考虑分页显示
3. **懒加载**：初次加载只显示自己的答案，点击后才加载其他成员

---

## 📞 技术支持

### 文档资源
- 完整技术文档：`V3.9_TEAM_COLLABORATION_FEATURE.md`
- 项目 README：`README.md`
- API 文档：README.md 的 API 接口章节

### 开发环境
- **开发服务器**：https://3000-i1l7k2pbfdion8sxilbu1-6532622b.e2b.dev
- **生产环境**：https://review-system.pages.dev
- **Cloudflare Dashboard**：https://dash.cloudflare.com/pages/view/review-system

---

## ✅ 部署检查清单

部署完成后，请逐项检查：

- [ ] 生产网站可以正常访问
- [ ] 用户可以登录
- [ ] 可以创建团队复盘
- [ ] 团队复盘详情页显示"查看团队答案"按钮
- [ ] 点击按钮进入团队协作界面
- [ ] 可以填写和保存自己的答案
- [ ] 可以看到其他成员的答案（如果有）
- [ ] 完成状态正确显示
- [ ] 创建者可以删除其他成员的答案
- [ ] 刷新功能正常工作
- [ ] 中英文切换正常

---

**部署日期**: 2025-10-13  
**版本**: V3.9  
**开发者**: Claude AI Assistant  
**功能**: 团队协作复盘
