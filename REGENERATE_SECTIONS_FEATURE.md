# 重新生成小节功能说明

## 功能概述

「重新生成」按钮位于每个章节标题行，允许用户为该章节重新生成小节大纲。这个功能会删除旧的小节（包括已生成的内容），并根据章节主题重新生成新的小节结构。

## 按钮位置

```
┌─────────────────────────────────────────────────────────┐
│ 第1章: 企业数栈在不同层级的应用场景                    │
│ [✏️编辑]  [🔄重新生成]  [⬇️展开/折叠]                  │
└─────────────────────────────────────────────────────────┘
```

## 功能特点

### 1. 智能安全检查

系统会自动检查当前章节的小节状态：

#### 情况 A：已有生成内容的小节
```
⚠️ 警告：重新生成小节将会覆盖已有内容！

第1章当前有 5 个小节，其中部分小节已经生成了内容。

重新生成将：
1. 删除所有现有小节
2. 重新生成新的小节大纲
3. 已生成的内容将永久丢失

确定要继续吗？
```

**二次确认：**
```
⚠️ 最后确认

您即将删除第1章的所有小节和内容。
此操作不可撤销！

是否确定继续？
```

#### 情况 B：只有小节大纲（未生成内容）
```
⚠️ 第1章当前有 5 个小节（尚未生成内容）。

重新生成将删除这些小节大纲。

确定要继续吗？
```

#### 情况 C：没有任何小节
直接进入下一步，询问生成数量。

### 2. 自定义小节数量

```
请输入要为"第1章: 企业数栈在不同层级的应用场景"生成的小节数量：

建议：3-10个小节
当前章节描述：简述企业数栈在各个层级中的应用...

[输入框: 5]
```

**验证规则：**
- 最少：1 个小节
- 最多：20 个小节
- 建议：3-10 个小节

### 3. AI Prompt 编辑

系统会显示默认的 AI Prompt，用户可以编辑：

```
你是一位专业的书籍内容规划专家。

书籍主题：人工智能实战指南
主题描述：深入浅出地介绍AI技术在企业中的应用...

当前章节：第1章 - 企业数栈在不同层级的应用场景
章节描述：简述企业数栈在各个层级中的应用...

请为这个章节重新生成5个小节标题。

要求：
1. 每个小节标题50字以内
2. 小节内容要围绕章节主题展开
3. 小节之间要有逻辑关系和递进性
4. 请按照JSON格式返回：
{
  "sections": [
    {"number": 1, "title": "小节标题", "description": "小节简介（50字内）"},
    ...
  ]
}

只返回JSON，不要其他说明文字。
```

用户可以：
- ✅ 修改书籍主题描述
- ✅ 调整小节数量
- ✅ 添加额外要求
- ✅ 修改输出格式要求
- ❌ 不要修改 JSON 结构格式

### 4. 生成过程

```
🤖 AI正在为第1章重新生成5个小节...
```

**生成时间：** 约 5-15 秒

**生成后：**
```
✅ 第1章的小节已重新生成！共5个小节。
```

## 完整流程图

```
用户点击「重新生成」按钮
    ↓
检查是否已有小节
    ↓
┌───────────────┐
│ 有已生成内容？ │
└───────────────┘
    ↓ 是          ↓ 否
双重确认      单次确认/直接进入
    ↓              ↓
用户确认后 → 询问小节数量
    ↓
验证输入（1-20）
    ↓
显示 AI Prompt 编辑器
    ↓
用户编辑/确认 Prompt
    ↓
调用 AI API 生成小节
    ↓
删除旧小节 + 插入新小节
    ↓
刷新页面显示新小节
    ↓
✅ 完成
```

## API 端点

### 后端端点
```
POST /api/ai-books/:id/chapters/:chapterId/regenerate-sections
```

### 请求参数
```json
{
  "num_sections": 5,
  "prompt": "自定义的 AI Prompt...",
  "target_word_count": 1000
}
```

### 响应示例
```json
{
  "success": true,
  "sections": [
    {
      "id": 123,
      "section_number": 1,
      "title": "1.1 企业数栈：从概念到实践",
      "description": "介绍企业数栈的基本概念和核心价值",
      "status": "draft",
      "current_word_count": 0,
      "target_word_count": 1000
    },
    ...
  ],
  "message": "Sections regenerated successfully"
}
```

## 前端实现

### 文件位置
`public/static/ai_books.js`

### 核心函数
```javascript
async regenerateSingleChapter(chapterId) {
  // 1. 获取章节信息
  // 2. 检查已有小节和内容
  // 3. 显示确认对话框
  // 4. 询问小节数量
  // 5. 显示 Prompt 编辑器
  // 6. 调用 API
  // 7. 更新 UI
}
```

### 按钮绑定
```html
<button onclick="AIBooksManager.regenerateSingleChapter(${chapter.id})" 
        class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1.5 rounded-lg"
        title="重新生成此章节的小节">
  <i class="fas fa-sync-alt mr-1"></i>重新生成
</button>
```

## 使用场景

### 1. 章节主题调整
当章节标题或描述发生重大变化时，重新生成小节以匹配新主题。

### 2. 小节结构不满意
如果 AI 生成的小节结构不理想，可以重新生成获得更好的大纲。

### 3. 增减小节数量
需要更多或更少的小节时，重新生成并指定新的数量。

### 4. 改变内容方向
想要从不同角度展开章节内容时，编辑 Prompt 后重新生成。

## 注意事项

### ⚠️ 重要警告

1. **数据不可恢复**
   - 重新生成会永久删除所有小节
   - 已生成的内容将丢失
   - 操作不可撤销

2. **双重确认**
   - 如果有已生成内容，需要两次确认
   - 第一次：了解将要删除的内容
   - 第二次：最后确认操作

3. **AI 生成时间**
   - 生成过程需要 5-15 秒
   - 请耐心等待，不要重复点击
   - 网络问题可能导致超时

### 💡 最佳实践

1. **备份重要内容**
   - 如果小节中有重要内容，先复制保存
   - 或者使用「导出HTML」功能备份整本书

2. **合理设置小节数量**
   - 短章节：3-5 个小节
   - 中等章节：5-8 个小节
   - 长章节：8-10 个小节
   - 避免超过 15 个小节（太细碎）

3. **优化 Prompt**
   - 在默认 Prompt 基础上添加具体要求
   - 说明希望的展开方式和侧重点
   - 提供关键词或参考资料

4. **分阶段生成**
   - 先生成章节大纲
   - 再为每个章节生成小节
   - 最后生成每个小节的内容

## 常见问题

### Q1: 为什么需要确认两次？
**A:** 当章节中有已生成内容的小节时，为了防止用户误操作导致内容丢失，系统会要求双重确认。这是一个安全措施。

### Q2: 可以只重新生成部分小节吗？
**A:** 目前不支持。重新生成会删除所有小节并创建新的。如果只想修改个别小节，请使用小节的「编辑」功能。

### Q3: 生成的小节数量可以和请求的不一样吗？
**A:** 理论上可能，因为 AI 可能会根据内容适当调整。但通常会严格按照请求的数量生成。

### Q4: 重新生成失败怎么办？
**A:** 如果 API 调用失败，系统会使用 Mock 数据生成小节，确保不会出现空白状态。Mock 数据格式正确，可以手动编辑。

### Q5: 为什么有时生成的小节质量不高？
**A:** 可能原因：
- 章节描述不够清晰
- 小节数量设置不合理
- Prompt 没有足够的指导信息
建议：编辑 Prompt，添加更多上下文和要求。

## 技术细节

### 安全检查逻辑

```javascript
const hasGeneratedContent = chapter.sections && 
  chapter.sections.some(s => s.content && s.content.trim().length > 0);

if (hasGeneratedContent) {
  // 双重确认流程
} else if (chapter.sections && chapter.sections.length > 0) {
  // 单次确认流程
} else {
  // 直接询问数量
}
```

### API 调用

```javascript
const response = await axios.post(
  `/api/ai-books/${this.currentBook.id}/chapters/${chapterId}/regenerate-sections`,
  { 
    num_sections: numSections,
    prompt: finalPrompt 
  }
);
```

### 数据库操作

后端会执行以下操作：
```sql
-- 1. 删除所有小节
DELETE FROM ai_sections WHERE chapter_id = ?

-- 2. 插入新小节
INSERT INTO ai_sections (
  chapter_id, book_id, section_number, 
  title, description, sort_order, status, target_word_count
) VALUES (?, ?, ?, ?, ?, ?, 'draft', ?)

-- 3. 更新章节时间戳
UPDATE ai_chapters SET updated_at = CURRENT_TIMESTAMP WHERE id = ?
```

## 版本历史

- **v1.0** (2025-11-20)
  - ✅ 初始实现
  - ✅ 安全确认机制
  - ✅ Prompt 编辑功能
  - ✅ 自定义小节数量

- **v1.1** (2025-11-20)
  - ✅ 删除多余的章节重新生成端点
  - ✅ 优化确认提示文案
  - ✅ 添加完整的功能文档

## 相关功能

- **生成小节**：为没有小节的章节生成初始小节
- **编辑小节标题**：修改单个小节的标题
- **编辑小节描述**：修改单个小节的描述
- **生成小节内容**：为小节生成实际文字内容
- **重新生成内容**：重新生成单个小节的内容

---

**文档更新时间**: 2025-11-20
**功能状态**: ✅ 正常运行
**相关文件**: 
- `public/static/ai_books.js` (前端)
- `src/routes/ai_books.ts` (后端)
