# 🚨 紧急修复：403 和 429 错误

## 问题现状

**错误代码**：
- ❌ `403 Forbidden` - 无法发送到未验证的邮箱
- ❌ `429 Too Many Requests` - 超出速率限制

**原因**：
`onboarding@resend.dev` 是 Resend 的测试域名，有严格限制：
- 只能发送到您在 Resend 控制台中手动验证过的邮箱地址
- 不能发送到系统中的任意用户
- 有严格的速率限制

---

## ✅ 立即解决方案（2种选择）

### 🎯 方案 A：验证自定义域名（推荐，一劳永逸）

**时间**：15-30 分钟
**优点**：彻底解决问题，可以发送到任何邮箱
**适用**：生产环境长期使用

#### 步骤：

1. **登录 Resend 控制台**
   - 访问：https://resend.com/domains
   - 点击 "Add Domain"
   - 输入：`ireviewsystem.com`

2. **添加 DNS 记录**
   
   Resend 会显示需要添加的 DNS 记录，前往您的域名 DNS 管理页面添加：

   ```
   记录 1 - SPF (TXT)
   主机名：@
   值：v=spf1 include:_spf.resend.com ~all
   
   记录 2 - DKIM (TXT)
   主机名：resend._domainkey
   值：[Resend 提供的长字符串，从控制台复制]
   
   记录 3 - DMARC (TXT)
   主机名：_dmarc
   值：v=DMARC1; p=none
   ```

3. **等待验证**
   - DNS 传播：通常 15-30 分钟
   - Resend 会自动检测并验证
   - 状态变为 "Verified" ✅ 即可使用

4. **更新代码**
   ```typescript
   // src/utils/email.ts 第 22 行
   from: 'Review System <noreply@ireviewsystem.com>',
   ```

5. **重新部署**
   ```bash
   npm run build
   npx wrangler pages deploy dist --project-name review-system
   ```

---

### 🔧 方案 B：手动验证收件人邮箱（临时方案）

**时间**：5 分钟
**优点**：快速临时解决
**缺点**：每个用户都需要验证，不适合长期

#### 步骤：

1. **获取所有用户邮箱**
   - 登录管理后台
   - 查看用户列表，记录所有邮箱地址

2. **在 Resend 添加验证邮箱**
   - 访问：https://resend.com/settings/emails
   - 点击 "Add Email"
   - 逐个添加 6 个用户的邮箱地址

3. **用户确认验证**
   - 每个用户会收到验证邮件
   - 点击邮件中的验证链接
   - 完成验证

4. **再次测试群发**
   - 所有邮箱验证后
   - 使用 `onboarding@resend.dev` 发送
   - 应该可以成功发送

**注意**：这个方案只是临时解决，每次新用户注册都需要重复这个过程。

---

## 📊 对比分析

| 特性 | 方案 A：验证域名 | 方案 B：验证邮箱 |
|------|-----------------|-----------------|
| **设置时间** | 15-30 分钟 | 5 分钟/用户 |
| **是否永久** | ✅ 是 | ❌ 否 |
| **新用户** | ✅ 无需操作 | ❌ 需要验证 |
| **发送限制** | ✅ 任意邮箱 | ❌ 仅验证邮箱 |
| **专业性** | ✅ 自定义域名 | ❌ 测试域名 |
| **送达率** | ✅ 更高 | ⚠️ 较低 |
| **推荐度** | ⭐⭐⭐⭐⭐ | ⭐⭐ |

---

## 🎯 我的建议

**立即执行方案 A**（验证自定义域名）

理由：
1. 这是生产环境，需要可靠的邮件发送
2. 一次配置，永久解决
3. 提升专业形象
4. 改善邮件送达率
5. 避免重复工作

**方案 B 只适用于**：
- 紧急测试
- 临时演示
- 用户数量固定且很少

---

## ❓ 常见问题

### Q1: 我没有域名的 DNS 管理权限怎么办？
**A**: 联系域名管理员，提供 Resend 的 DNS 记录要求，请其添加。

### Q2: DNS 记录添加后多久生效？
**A**: 通常 15-30 分钟，最长 48 小时。可以用 https://mxtoolbox.com/ 检查。

### Q3: 验证失败怎么办？
**A**: 
1. 确认 DNS 记录无误（主机名、值都要完全匹配）
2. 等待更长时间
3. 清除 DNS 缓存
4. 联系 Resend 支持

### Q4: 429 错误是什么原因？
**A**: 超出 Resend 免费套餐限制（100封/天），需要等待或升级套餐。

### Q5: 可以同时发送到 Gmail、Outlook、QQ 邮箱吗？
**A**: 验证域名后可以，但建议：
- 控制发送速率（避免被标记为垃圾邮件）
- 使用延迟发送（每封间隔 1-2 秒）
- 监控退信率

---

## 📞 需要帮助？

如果遇到问题，请提供：
1. Resend 控制台截图（域名验证状态）
2. DNS 管理页面截图
3. 具体的错误信息
4. 已等待的时间

我会立即协助您解决！

---

## 🔗 相关资源

- Resend 域名管理：https://resend.com/domains
- Resend 文档：https://resend.com/docs/dashboard/domains/introduction
- DNS 检查工具：https://mxtoolbox.com/
- 详细验证指南：查看 `RESEND_DOMAIN_VERIFICATION.md`
