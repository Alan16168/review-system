# V3.9 团队协作复盘功能 - 技术文档

## 📋 功能概述

V3.9 版本实现了**团队协作复盘功能**，允许团队成员对同一个复盘的9个问题分别提供自己的答案，实现真正的多人协作复盘。

### 核心特性

1. ✅ **并列显示答案**：每个问题显示所有团队成员的答案，便于对比和讨论
2. ✅ **权限控制**：成员只能编辑自己的答案，复盘创建者可以删除其他人的答案
3. ✅ **自动保存**：答案修改后自动保存，无需额外提交步骤
4. ✅ **完成状态**：显示每个成员的完成进度（已完成X/9题）
5. ✅ **刷新更新**：支持手动刷新查看最新答案（无需实时推送）

---

## 🗄️ 数据库变更

### 新增表：team_review_answers

```sql
CREATE TABLE IF NOT EXISTS team_review_answers (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  review_id INTEGER NOT NULL,
  user_id INTEGER NOT NULL,
  question_number INTEGER NOT NULL CHECK (question_number >= 1 AND question_number <= 9),
  answer TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (review_id) REFERENCES reviews(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE(review_id, user_id, question_number)
);

CREATE INDEX IF NOT EXISTS idx_team_review_answers_review_id ON team_review_answers(review_id);
CREATE INDEX IF NOT EXISTS idx_team_review_answers_user_id ON team_review_answers(user_id);
CREATE INDEX IF NOT EXISTS idx_team_review_answers_question ON team_review_answers(review_id, question_number);
```

**说明**：
- 每个用户对每个复盘的每个问题只能有一个答案
- `UNIQUE(review_id, user_id, question_number)` 确保数据唯一性
- 级联删除：复盘或用户被删除时，相关答案自动删除

---

## 🔌 新增 API 接口

### 1. GET /api/reviews/:id/team-answers

**功能**：获取复盘的所有团队成员答案

**权限**：复盘创建者、协作者、团队成员

**响应示例**：
```json
{
  "answersByQuestion": {
    "1": [
      {
        "user_id": 1,
        "username": "Alice",
        "email": "alice@example.com",
        "answer": "我的目标是提升团队效率...",
        "updated_at": "2025-10-13 10:30:00"
      },
      {
        "user_id": 2,
        "username": "Bob",
        "email": "bob@example.com",
        "answer": "我的目标是优化代码质量...",
        "updated_at": "2025-10-13 10:35:00"
      }
    ],
    "2": [...],
    ...
    "9": [...]
  },
  "completionStatus": [
    {
      "user_id": 1,
      "username": "Alice",
      "email": "alice@example.com",
      "completed_count": 9
    },
    {
      "user_id": 2,
      "username": "Bob",
      "email": "bob@example.com",
      "completed_count": 5
    }
  ],
  "currentUserId": 1
}
```

---

### 2. PUT /api/reviews/:id/my-answer/:questionNumber

**功能**：保存或更新当前用户对某个问题的答案

**权限**：复盘创建者、协作者、团队成员

**请求体**：
```json
{
  "answer": "这是我对这个问题的回答..."
}
```

**响应**：
```json
{
  "message": "Answer saved successfully"
}
```

**说明**：
- 使用 `INSERT ... ON CONFLICT ... DO UPDATE` 实现自动插入或更新
- 不能保存空答案

---

### 3. DELETE /api/reviews/:id/answer/:userId/:questionNumber

**功能**：删除指定用户对某个问题的答案（仅复盘创建者可用）

**权限**：仅复盘创建者

**响应**：
```json
{
  "message": "Answer deleted successfully"
}
```

**错误响应**：
```json
{
  "error": "Only the review owner can delete others' answers"
}
```

---

## 🎨 前端界面变更

### 1. 复盘详情页面增强

在团队复盘详情页面，新增**"查看团队答案"**按钮：

```html
<button onclick="showTeamReviewCollaboration(reviewId)" 
        class="px-4 py-2 bg-green-600 text-white rounded-lg">
  <i class="fas fa-users mr-2"></i>查看团队答案
</button>
```

### 2. 新增函数：showTeamReviewCollaboration(id)

**功能**：显示团队协作复盘界面

**界面布局**：

```
┌─────────────────────────────────────────────────┐
│ 返回 | 复盘标题 (团队图标)          | 刷新按钮 │
│ 提示：刷新页面查看最新答案                        │
├─────────────────────────────────────────────────┤
│ 完成状态：                                       │
│ ┌─────────┐ ┌─────────┐ ┌─────────┐            │
│ │ Alice   │ │ Bob     │ │ Charlie │            │
│ │ 9/9 ✓   │ │ 5/9 ⏰  │ │ 0/9 ⏰  │            │
│ └─────────┘ └─────────┘ └─────────┘            │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ 问题1：我的目标是什么？                          │
├─────────────────────────────────────────────────┤
│ 我的答案 (可编辑)        [自动保存 ✓]           │
│ ┌─────────────────────────────────────────┐    │
│ │ [文本框 - 可编辑]                         │    │
│ └─────────────────────────────────────────┘    │
│                                                  │
│ 成员答案 (2)                                     │
│ ┌─────────────────────────────────────────┐    │
│ │ 👤 Alice  | 2025-10-13 10:30  [删除]    │    │
│ │ 我的目标是提升团队效率...                │    │
│ └─────────────────────────────────────────┘    │
│ ┌─────────────────────────────────────────┐    │
│ │ 👤 Bob    | 2025-10-13 10:35            │    │
│ │ 我的目标是优化代码质量...                │    │
│ └─────────────────────────────────────────┘    │
└─────────────────────────────────────────────────┘

[重复问题2-9的相同布局]
```

### 3. 新增函数：handleSaveTeamAnswer(reviewId, questionNumber)

**功能**：自动保存用户答案

**触发条件**：textarea 的 `onchange` 事件

**特性**：
- 实时保存，无需点击保存按钮
- 显示保存状态（✓ 自动保存）
- 验证答案不能为空

### 4. 新增函数：handleDeleteTeamAnswer(reviewId, userId, questionNumber)

**功能**：删除其他成员的答案（仅创建者可见此按钮）

**特性**：
- 删除前弹出确认对话框
- 删除成功后自动刷新页面

---

## 🌐 国际化支持

### 新增翻译键（中文）

```javascript
'teamAnswers': '团队答案',
'myAnswer': '我的答案',
'memberAnswers': '成员答案',
'completionStatus': '完成状态',
'completed': '已完成',
'completedQuestions': '已完成 {count}/9 题',
'notStarted': '未开始',
'answerPlaceholder': '在此输入您的答案...',
'autoSaved': '自动保存',
'deleteAnswer': '删除答案',
'confirmDeleteAnswer': '确定要删除这个答案吗？',
'viewTeamAnswers': '查看团队答案',
'refreshToSeeUpdates': '刷新页面查看最新答案',
'noMemberAnswers': '暂无成员答案',
'answerSaved': '答案已保存',
'answerDeleted': '答案已删除',
```

### 新增翻译键（英文）

```javascript
'teamAnswers': 'Team Answers',
'myAnswer': 'My Answer',
'memberAnswers': 'Member Answers',
'completionStatus': 'Completion Status',
'completed': 'Completed',
'completedQuestions': 'Completed {count}/9 questions',
'notStarted': 'Not started',
'answerPlaceholder': 'Enter your answer here...',
'autoSaved': 'Auto-saved',
'deleteAnswer': 'Delete Answer',
'confirmDeleteAnswer': 'Are you sure you want to delete this answer?',
'viewTeamAnswers': 'View Team Answers',
'refreshToSeeUpdates': 'Refresh page to see latest answers',
'noMemberAnswers': 'No member answers yet',
'answerSaved': 'Answer saved',
'answerDeleted': 'Answer deleted',
```

---

## 🔧 后端代码变更

### src/utils/db.ts 新增函数

1. **getTeamReviewAnswers(db, reviewId)**
   - 获取复盘的所有团队答案
   - 包含用户名和邮箱信息（JOIN users 表）

2. **getMyTeamAnswer(db, reviewId, userId, questionNumber)**
   - 获取特定用户对特定问题的答案

3. **saveMyTeamAnswer(db, reviewId, userId, questionNumber, answer)**
   - 保存或更新答案
   - 使用 `ON CONFLICT` 实现 upsert

4. **deleteTeamAnswer(db, reviewId, userId, questionNumber)**
   - 删除特定答案

5. **getTeamAnswerCompletionStatus(db, reviewId)**
   - 获取所有成员的完成状态
   - 统计每人已完成的题目数量

### src/routes/reviews.ts 新增路由

- `GET /api/reviews/:id/team-answers`
- `PUT /api/reviews/:id/my-answer/:questionNumber`
- `DELETE /api/reviews/:id/answer/:userId/:questionNumber`

---

## 🎯 使用场景

### 场景 1：创建团队复盘

1. 用户创建复盘时选择团队
2. 团队成员在复盘列表中看到这个复盘
3. 点击"查看详情"进入复盘详情页

### 场景 2：团队协作答题

1. 成员点击"查看团队答案"按钮
2. 看到9个问题，每个问题显示：
   - 自己的答案（可编辑）
   - 其他成员的答案（只读）
3. 在文本框中输入答案，修改后自动保存
4. 刷新页面可以看到其他成员的最新答案

### 场景 3：复盘创建者管理

1. 创建者可以看到所有成员的答案
2. 创建者可以删除不合适的答案（每个答案旁有删除按钮）
3. 删除前会弹出确认对话框
4. 删除后页面自动刷新

### 场景 4：查看完成状态

1. 页面顶部显示所有成员的完成进度
2. 已完成9题的成员显示绿色勾选标记
3. 未完成的成员显示进度（如 5/9）
4. 便于团队管理者跟踪进度

---

## 🧪 测试场景

### 测试 1：多用户协作

1. 用户A登录，创建团队复盘
2. 用户A填写自己的答案
3. 用户B登录，打开同一复盘
4. 用户B填写自己的答案
5. 用户A刷新页面，应该看到用户B的答案

### 测试 2：权限控制

1. 用户B尝试删除用户A的答案 → 应该看不到删除按钮
2. 用户A可以看到并删除用户B的答案 → 成功删除
3. 用户B尝试编辑用户A的答案 → 文本框应该是只读的

### 测试 3：自动保存

1. 用户在文本框中输入答案
2. 切换到其他文本框（触发 onchange）
3. 应该看到"自动保存 ✓"提示
4. 刷新页面，答案应该被保存

### 测试 4：完成状态

1. 用户A完成全部9题
2. 用户B只完成5题
3. 完成状态区域应该显示：
   - 用户A: 9/9 ✓（绿色）
   - 用户B: 5/9 ⏰（灰色）

---

## 🚀 部署步骤

### 本地开发环境

1. **应用数据库迁移**：
```bash
cd /home/user/webapp
npx wrangler d1 migrations apply webapp-production --local
```

2. **构建项目**：
```bash
npm run build
```

3. **启动开发服务器**：
```bash
pm2 start ecosystem.config.cjs
```

4. **测试访问**：
```bash
curl http://localhost:3000
```

### 生产环境部署

1. **应用生产数据库迁移**：
```bash
cd /home/user/webapp
npx wrangler d1 migrations apply webapp-production
```

2. **构建项目**：
```bash
npm run build
```

3. **部署到 Cloudflare Pages**：
```bash
npm run deploy:prod
```

4. **验证部署**：
```bash
curl https://review-system.pages.dev/api/reviews/1/team-answers
```

---

## 📝 注意事项

### 性能优化

1. **索引优化**：在 review_id, user_id, question_number 上创建了复合索引
2. **批量查询**：一次性获取所有答案，减少数据库查询次数
3. **前端缓存**：不实时更新，用户手动刷新查看最新数据

### 数据一致性

1. **唯一约束**：确保每个用户对每个问题只有一个答案
2. **级联删除**：复盘或用户删除时，相关答案自动清理
3. **事务处理**：使用 SQLite 的 UNIQUE 约束自动处理并发冲突

### 安全性

1. **权限验证**：每个 API 都验证用户是否有权访问该复盘
2. **删除权限**：只有复盘创建者可以删除其他人的答案
3. **SQL 注入防护**：使用参数化查询（bind）

---

## 🎉 功能亮点

1. ✨ **真正的多人协作**：不是简单的共享编辑，而是每个人都有独立的答案空间
2. ✨ **对比学习**：可以看到不同视角的答案，促进团队学习和讨论
3. ✨ **简单易用**：自动保存，无需额外操作
4. ✨ **清晰的权限**：每个人只能编辑自己的答案，避免误操作
5. ✨ **进度跟踪**：一目了然地看到团队完成情况

---

## 📊 数据流程图

```
用户A填写答案 → API: PUT /my-answer/1 → team_review_answers表
                                            ↓
用户B打开复盘 → API: GET /team-answers → 返回所有答案（包含用户A的）
                                            ↓
用户B填写答案 → API: PUT /my-answer/1 → team_review_answers表
                                            ↓
用户A刷新页面 → API: GET /team-answers → 返回所有答案（包含用户B的）
```

---

## 📚 相关文档

- 数据库迁移文件：`migrations/0007_add_team_review_answers.sql`
- 后端工具函数：`src/utils/db.ts`
- API 路由：`src/routes/reviews.ts`
- 前端界面：`public/static/app.js` (showTeamReviewCollaboration函数)
- 国际化配置：`public/static/i18n.js`

---

**开发者**: Claude AI Assistant  
**版本**: V3.9  
**更新日期**: 2025-10-13  
**功能**: 团队协作复盘
