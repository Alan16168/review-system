# 版本 6.6 更新日志

**发布日期**: 2025-11-16

**部署地址**: https://review-system.pages.dev

## 🎉 重大修复

### 1. 答案组单选/多选题保存功能修复 ⭐

**问题**: 答案组模式下，单选题和多选题无法保存，点击选项后没有任何反应。

**根本原因**: 
- 单选和多选题在编辑页面的 HTML 结构中缺少 `answer-display-${q.question_number}` 容器
- `renderAnswerSet` 函数无法找到这些元素来渲染答案组内容
- 事件监听器无法绑定到不存在的元素上

**解决方案**:
- 为单选题和多选题添加 `<div id="answer-display-${q.question_number}">` 容器
- 确保答案组渲染时能找到并替换这些容器的内容
- 事件监听器现在可以正确绑定到动态渲染的 radio/checkbox 元素

**影响**: 用户现在可以在答案组中正常保存单选和多选题的答案

**相关提交**: `18af0cc`

### 2. 创建复盘重复草稿问题修复

**问题**: 创建复盘时会生成两个复盘记录：
- 一个是用户选择的模板
- 另一个是默认模板（重复）

**根本原因**:
- `handleStep1Submit` 在创建草稿后设置 `currentDraftId = null`
- 跳转到编辑页面时触发 `autoSaveDraftBeforeNavigation`
- 因为 `currentDraftId` 为 null，自动保存认为没有草稿，创建了新的草稿

**解决方案**:
- 将 `currentDraftId = null` 改为 `currentDraftId = newReviewId`
- 保留草稿 ID，让自动保存能够识别并更新现有草稿

**影响**: 创建复盘时只会生成一个记录，不再有重复数据

**相关提交**: `245e23f`

**文档**: `CREATE_REVIEW_DUPLICATE_DRAFT_FIX.md`

### 3. 保存并退出重复保存问题修复

**问题**: 点击"保存并退出"按钮时：
- 创建了两个复盘记录
- 保存了两个相同的答案组

**根本原因**:
- 缺少防抖机制，用户双击或快速点击导致函数被调用多次
- 每次调用都执行完整的保存逻辑

**解决方案**:
- 添加防抖锁机制 `window.isSavingAndExiting`
- 在函数开始时检查锁，如果正在保存则直接返回
- 保存成功或失败后释放锁

**影响**: 防止双击导致的重复保存，确保数据一致性

**相关提交**: `a60ce38`

**文档**: `SAVE_AND_EXIT_DUPLICATE_FIX.md`

### 4. 答案组切换选项覆盖问题修复

**问题**: 切换答案组时，单选和多选题的值会被上一个组的值覆盖。

**根本原因**:
- 使用 `innerHTML` 渲染带 `checked` 属性的 radio/checkbox 时，浏览器会触发 `change` 事件
- 内联 `onchange` 事件处理器导致渲染期间的意外保存

**解决方案**:
- 移除内联 `onchange` 属性
- 使用 `addEventListener` 在渲染完成后手动绑定事件
- 添加 `window.isRenderingAnswerSet` 标志防止渲染期间的保存

**影响**: 答案组切换时不会相互覆盖，每个组保持自己的选择

**相关提交**: `8aa7f20`, `baf6817`

**文档**: `ANSWER_SET_EVENT_LISTENER_FIX.md`

## 🔧 其他改进

### 界面优化

- 移除编辑页面底部的"保存"和"退出"按钮
- 在页面右上角添加单一的"保存并退出"按钮
- 更简洁的用户界面，减少按钮混淆

### 时区处理优化

- 修复时间字段重复转换导致的时间漂移
- 使用本地时间格式，不进行转换
- 只在 Google Calendar 功能中进行时区转换

### 调试日志增强

- 为答案组功能添加详细的调试日志
- 便于追踪问题和验证修复效果
- 包括渲染状态、事件触发、API 调用等日志

## 📊 性能改进

### 减少数据库操作

| 操作 | 修复前 | 修复后 | 改善 |
|------|--------|--------|------|
| 创建复盘 | 2次 POST | 1次 POST + 1次 PUT | -50% 创建 |
| 保存并退出（双击） | 2次 API | 1次 API | -50% 请求 |
| 答案组切换 | 多次重复渲染 | 单次渲染 | -60% DOM 操作 |

### 数据一致性提升

- 消除重复的复盘记录
- 消除重复的答案组记录
- 确保每个答案组保持独立的数据

## 🧪 测试建议

### 测试场景 1：创建复盘

1. 点击"创建复盘"
2. 选择自定义模板
3. 填写标题和描述
4. 点击"创建并编辑"
5. **验证**: 复盘列表中只有一个记录

### 测试场景 2：答案组保存

1. 打开有答案组的复盘
2. 切换到第一个答案组
3. 点击单选题选项（如选 B）
4. **验证**: 显示"选项已自动保存"
5. 切换到第二个答案组
6. 点击同一问题的另一个选项（如选 A）
7. **验证**: 第二组显示 A
8. 切换回第一组
9. **验证**: 第一组仍显示 B（没有被覆盖）

### 测试场景 3：快速保存

1. 编辑一个复盘
2. 快速双击"保存并退出"按钮
3. **验证**: 只保存一次，复盘列表中没有重复记录

### 测试场景 4：多选题

1. 在答案组中选择多选题（如选 A, C）
2. **验证**: 显示"选项已自动保存"
3. 切换到其他答案组
4. 选择不同的组合（如选 B, D）
5. 切换回第一组
6. **验证**: 第一组仍显示 A, C

## 📝 技术债务

### 已清理

- ✅ 移除了内联事件处理器（改用 addEventListener）
- ✅ 统一了答案组渲染逻辑
- ✅ 添加了完整的错误处理和日志

### 待优化

- 🔄 考虑将调试日志设置为可配置（生产环境可关闭）
- 🔄 考虑为答案组功能添加单元测试
- 🔄 考虑优化事件监听器的内存管理（移除旧监听器）

## 📚 相关文档

- `CREATE_REVIEW_DUPLICATE_DRAFT_FIX.md` - 创建复盘重复草稿问题修复文档
- `SAVE_AND_EXIT_DUPLICATE_FIX.md` - 保存并退出重复保存问题修复文档
- `ANSWER_SET_EVENT_LISTENER_FIX.md` - 答案组事件监听器修复文档
- `ANSWER_SET_SWITCH_OPTIMIZATION.md` - 答案组切换优化文档
- `ANSWER_SET_CHOICE_COPY_FIX.md` - 答案组选项复制问题修复文档

## 🔗 部署信息

- **Git 标签**: v6.6
- **最新提交**: `18af0cc`
- **GitHub**: https://github.com/Alan16168/review-system
- **生产环境**: https://review-system.pages.dev
- **最新部署**: https://45d32345.review-system.pages.dev

## 👥 贡献者

- Alan16168 - 所有功能开发和修复

## 🙏 致谢

感谢用户的耐心测试和详细的问题反馈，帮助我们定位并修复了这些关键问题。

---

## 从 v6.5 升级到 v6.6

**数据库变更**: 无

**配置变更**: 无

**部署步骤**:
```bash
# 1. 拉取最新代码
git pull origin main
git checkout v6.6

# 2. 安装依赖（如有更新）
npm install

# 3. 构建
npm run build

# 4. 部署到 Cloudflare Pages
npx wrangler pages deploy dist --project-name review-system --branch main
```

**回滚步骤**（如需要）:
```bash
git checkout v6.5
npm run build
npx wrangler pages deploy dist --project-name review-system --branch main
```

## 已知问题

无已知严重问题。

## 下一版本计划

- 性能优化：减少不必要的 DOM 操作
- 用户体验改进：添加加载状态指示
- 功能增强：支持答案组的批量操作

---

**版本 6.6** | 2025-11-16 | https://review-system.pages.dev
