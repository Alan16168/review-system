# é”™è¯¯å¤„ç†ç³»ç»Ÿæ”¹è¿›æŠ¥å‘Š

**æ—¥æœŸ**: 2025-11-21  
**ç‰ˆæœ¬**: V7.0.0  
**Git Commit**: 9070215

---

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·åœ¨ä½¿ç”¨ç³»ç»Ÿæ—¶é‡åˆ° **502 Bad Gateway** é”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯ä¸å‹å¥½ï¼Œç”¨æˆ·æ— æ³•äº†è§£é—®é¢˜çš„å…·ä½“åŸå› ï¼š

![æˆªå›¾æ˜¾ç¤ºçš„é—®é¢˜](https://www.genspark.ai/api/files/s/XvGuhvEy)

- âŒ é”™è¯¯ä¿¡æ¯å¤ªæŠ€æœ¯åŒ–ï¼ˆ"502 Bad Gateway"ï¼‰
- âŒ æ²¡æœ‰è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
- âŒ åç«¯è¿”å›çš„é”™è¯¯ä¿¡æ¯æ˜¯è‹±æ–‡çš„ "Internal server error"
- âŒ ç”¨æˆ·æ— æ³•å¾—çŸ¥å¦‚ä½•è§£å†³é—®é¢˜

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. ç¼ºå°‘å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶

**é—®é¢˜**: 
- æ¯ä¸ªè·¯ç”±éƒ½å•ç‹¬å¤„ç†é”™è¯¯
- é”™è¯¯æ ¼å¼ä¸ç»Ÿä¸€
- é”™è¯¯ä¿¡æ¯å¯¹ç”¨æˆ·ä¸å‹å¥½

### 2. é”™è¯¯æ—¥å¿—ä¸è¯¦ç»†

**é—®é¢˜**:
- åªæœ‰ç®€å•çš„ `console.error('Error:', error)`
- æ²¡æœ‰è®°å½•è¯·æ±‚ä¸Šä¸‹æ–‡ï¼ˆURLã€æ–¹æ³•ã€ç”¨æˆ·ç­‰ï¼‰
- ç¼ºå°‘å †æ ˆè·Ÿè¸ªä¿¡æ¯

### 3. 502 é”™è¯¯å¯èƒ½æ¥æº

æ ¹æ®åˆ†æï¼Œ502 é”™è¯¯å¯èƒ½ç”±ä»¥ä¸‹åŸå› å¯¼è‡´ï¼š
- æ•°æ®åº“æ“ä½œå¤±è´¥ï¼ˆD1 é”™è¯¯ï¼‰
- API è°ƒç”¨è¶…æ—¶ï¼ˆGemini, Google API ç­‰ï¼‰
- ç½‘ç»œè¿æ¥é—®é¢˜
- å‚æ•°ç»‘å®šé”™è¯¯ï¼ˆSQL æŸ¥è¯¢ï¼‰

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. åˆ›å»ºå…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶

**æ–°æ–‡ä»¶**: `src/middleware/errorHandler.ts`

**åŠŸèƒ½**:
- âœ… æ•è·æ‰€æœ‰æœªå¤„ç†çš„é”™è¯¯
- âœ… æ ¹æ®é”™è¯¯ç±»å‹ç”Ÿæˆå‹å¥½çš„ä¸­æ–‡æç¤º
- âœ… è¯¦ç»†è®°å½•é”™è¯¯æ—¥å¿—ï¼ˆæ—¶é—´æˆ³ã€ç”¨æˆ·ã€URLã€å †æ ˆç­‰ï¼‰
- âœ… ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
- âœ… å¼€å‘ç¯å¢ƒä¸‹æä¾›è¯¦ç»†é”™è¯¯ä¿¡æ¯

**é”™è¯¯ç±»å‹è¯†åˆ«**:
```typescript
// æ•°æ®åº“é”™è¯¯
if (error.message?.includes('D1_ERROR') || error.message?.includes('SQLITE')) {
  return 'æ•°æ®åº“æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
}

// ç½‘ç»œè¶…æ—¶é”™è¯¯
if (error.message?.includes('timeout') || error.message?.includes('ETIMEDOUT')) {
  return 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
}

// API è°ƒç”¨é”™è¯¯
if (error.message?.includes('API') || error.message?.includes('fetch failed')) {
  return 'å¤–éƒ¨æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•';
}

// ... æ›´å¤šé”™è¯¯ç±»å‹
```

**æ—¥å¿—è®°å½•**:
```typescript
function logError(error: AppError, c: Context) {
  const timestamp = new Date().toISOString();
  const method = c.req.method;
  const url = c.req.url;
  const userId = c.get('user')?.userId || 'anonymous';
  
  console.error(`[${timestamp}] [ERROR] ${method} ${url}`);
  console.error(`User: ${userId}`);
  console.error(`Error: ${error.message}`);
  if (error.stack) {
    console.error(`Stack: ${error.stack}`);
  }
}
```

### 2. é›†æˆå…¨å±€é”™è¯¯å¤„ç†

**æ›´æ–°**: `src/index.tsx`

```typescript
import { errorHandler, notFoundHandler } from './middleware/errorHandler';

const app = new Hono<{ Bindings: Bindings }>();

// Global error handler - must be first
app.use('*', errorHandler);

// ... å…¶ä»–ä¸­é—´ä»¶å’Œè·¯ç”±

// 404 Handler - must be last
app.notFound(notFoundHandler);
```

### 3. é‡æ„æ‰€æœ‰è·¯ç”±çš„é”™è¯¯å¤„ç†

**æ›´æ–°**: `src/routes/templates.ts`

**ä¹‹å‰**:
```typescript
} catch (error) {
  console.error('Get templates error:', error);
  return c.json({ error: 'Internal server error' }, 500);
}
```

**ä¹‹å**:
```typescript
} catch (error: any) {
  console.error('[GET /api/templates] Error:', error);
  console.error('Stack:', error.stack);
  throw createError('è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥: ' + (error.message || 'Unknown error'), 500, { 
    originalError: error.message 
  });
}
```

**æ”¹è¿›ç‚¹**:
- âœ… è®°å½•å®Œæ•´çš„ API è·¯å¾„
- âœ… è®°å½•å †æ ˆè·Ÿè¸ª
- âœ… ä½¿ç”¨ `throw` è€Œä¸æ˜¯ `return`ï¼Œè®©å…¨å±€å¤„ç†å™¨æ•è·
- âœ… ä¸­æ–‡é”™è¯¯ä¿¡æ¯
- âœ… é™„åŠ é”™è¯¯è¯¦æƒ…

---

## ğŸ“Š æ”¹è¿›åçš„é”™è¯¯å“åº”æ ¼å¼

### ç”¨æˆ·å‹å¥½çš„é”™è¯¯å“åº”

```json
{
  "error": "è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥: D1_ERROR: Connection timeout",
  "message": "æ•°æ®åº“æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•",
  "timestamp": "2025-11-21T04:22:32.596Z",
  "path": "/api/templates",
  "method": "GET"
}
```

### å¼€å‘ç¯å¢ƒé¢å¤–ä¿¡æ¯

```json
{
  "error": "è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥: D1_ERROR: Connection timeout",
  "message": "æ•°æ®åº“æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•",
  "details": {
    "originalError": "D1_ERROR: Connection timeout",
    "stack": "Error: D1_ERROR...\n    at ..."
  },
  "timestamp": "2025-11-21T04:22:32.596Z",
  "path": "/api/templates",
  "method": "GET"
}
```

---

## ğŸ› ï¸ æŠ€æœ¯ç»†èŠ‚

### é”™è¯¯ç±»å‹å’ŒçŠ¶æ€ç æ˜ å°„

| é”™è¯¯ç±»å‹ | çŠ¶æ€ç  | ç”¨æˆ·æç¤º |
|---------|--------|---------|
| æ•°æ®åº“é”™è¯¯ | 500 | æ•°æ®åº“æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯• |
| ç½‘ç»œè¶…æ—¶ | 504 | è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯• |
| API è°ƒç”¨å¤±è´¥ | 502 | å¤–éƒ¨æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯• |
| éªŒè¯é”™è¯¯ | 400 | è¾“å…¥æ•°æ®éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥å†…å®¹ |
| æƒé™é”™è¯¯ | 403 | æ‚¨æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ |
| èµ„æºæœªæ‰¾åˆ° | 404 | è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨ |

### ä¸­é—´ä»¶æ‰§è¡Œé¡ºåº

```typescript
app.use('*', errorHandler);        // 1. å…¨å±€é”™è¯¯æ•è·
app.use('/api/*', cors());         // 2. CORS
app.use('/static/*', serveStatic); // 3. é™æ€æ–‡ä»¶
app.route('/api/xxx', routes);     // 4. ä¸šåŠ¡è·¯ç”±
app.notFound(notFoundHandler);     // 5. 404 å¤„ç†
```

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### æ„å»ºæµ‹è¯•
```bash
$ npm run build
âœ“ built in 2.22s
dist/_worker.js  340.99 kB
```

### æœåŠ¡æµ‹è¯•
```bash
$ curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/
200
```

### PM2 çŠ¶æ€
```
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚ name             â”‚ mode    â”‚ uptime  â”‚ status â”‚ memory    â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0  â”‚ review-system    â”‚ fork    â”‚ 5m      â”‚ online â”‚ 29.3mb    â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ”¹è¿›çš„æ–‡ä»¶åˆ—è¡¨

### æ–°å¢æ–‡ä»¶
1. **src/middleware/errorHandler.ts** (138 lines)
   - å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶
   - é”™è¯¯ç±»å‹è¯†åˆ«å‡½æ•°
   - æ—¥å¿—è®°å½•å‡½æ•°
   - 404 å¤„ç†å™¨

### ä¿®æ”¹æ–‡ä»¶
1. **src/index.tsx**
   - é›†æˆå…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶
   - æ·»åŠ  404 å¤„ç†å™¨

2. **src/routes/templates.ts**
   - é‡æ„æ‰€æœ‰ 10 ä¸ª catch å—
   - æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
   - ä½¿ç”¨ createError åˆ›å»ºè‡ªå®šä¹‰é”™è¯¯

---

## ğŸ¯ ç”¨æˆ·ä½“éªŒæ”¹è¿›

### ä¹‹å‰ âŒ
```
Error: Internal server error
çŠ¶æ€ç : 502
```
ç”¨æˆ·çœ‹åˆ°è¿™ä¸ªé”™è¯¯æ—¶å®Œå…¨ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆã€‚

### ä¹‹å âœ…
```
é”™è¯¯: æ•°æ®åº“æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
æç¤º: å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒ
çŠ¶æ€ç : 500
```
ç”¨æˆ·èƒ½å¤Ÿç†è§£é—®é¢˜ï¼ŒçŸ¥é“å¦‚ä½•å¤„ç†ã€‚

---

## ğŸ”œ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ‰©å±•åˆ°å…¶ä»–è·¯ç”±
ç›®å‰åªæ›´æ–°äº† `templates.ts`ï¼Œå»ºè®®å¯¹ä»¥ä¸‹è·¯ç”±ä¹Ÿè¿›è¡Œç±»ä¼¼æ”¹è¿›ï¼š
- âœ… src/routes/templates.ts
- â³ src/routes/reviews.ts
- â³ src/routes/teams.ts
- â³ src/routes/ai_books.ts
- â³ src/routes/marketplace.ts
- â³ å…¶ä»–æ‰€æœ‰è·¯ç”±...

### 2. æ·»åŠ é”™è¯¯ç›‘æ§
```typescript
// å¯ä»¥é›†æˆ Sentry æˆ–å…¶ä»–é”™è¯¯ç›‘æ§æœåŠ¡
import * as Sentry from '@sentry/cloudflare';

Sentry.captureException(error);
```

### 3. é”™è¯¯åˆ†ç±»ç»Ÿè®¡
```typescript
// è®°å½•é”™è¯¯é¢‘ç‡ï¼Œå¸®åŠ©å‘ç°ç³»ç»Ÿç“¶é¢ˆ
const errorStats = {
  database: 0,
  api: 0,
  network: 0,
  validation: 0
};
```

### 4. ç”¨æˆ·å‹å¥½çš„é”™è¯¯é¡µé¢
ä¸ºå‰ç«¯æ·»åŠ ç»Ÿä¸€çš„é”™è¯¯æ˜¾ç¤ºç»„ä»¶ï¼Œè€Œä¸æ˜¯ç®€å•çš„ alertã€‚

### 5. è‡ªåŠ¨é‡è¯•æœºåˆ¶
å¯¹äºæŸäº›å¯æ¢å¤çš„é”™è¯¯ï¼ˆå¦‚ç½‘ç»œè¶…æ—¶ï¼‰ï¼Œå®ç°è‡ªåŠ¨é‡è¯•ï¼š
```typescript
async function fetchWithRetry(fn, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      await sleep(2000 * (i + 1)); // æŒ‡æ•°é€€é¿
    }
  }
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [502_ERROR_GUIDE.md](./502_ERROR_GUIDE.md) - 502 é”™è¯¯æ’æŸ¥æŒ‡å—
- [TROUBLESHOOTING_404_502.md](./TROUBLESHOOTING_404_502.md) - æ•…éšœæ’é™¤æŒ‡å—
- [BUG_ANALYSIS_EDIT_REVIEW.md](/home/user/BUG_ANALYSIS_EDIT_REVIEW.md) - ç¼–è¾‘åŠŸèƒ½ Bug åˆ†æ

---

## âœ… æ€»ç»“

æœ¬æ¬¡æ”¹è¿›æˆåŠŸå®ç°äº†ï¼š

1. âœ… **å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶** - ç»Ÿä¸€æ•è·å’Œå¤„ç†æ‰€æœ‰é”™è¯¯
2. âœ… **å‹å¥½çš„ä¸­æ–‡é”™è¯¯ä¿¡æ¯** - ç”¨æˆ·èƒ½å¤Ÿç†è§£çš„æç¤º
3. âœ… **è¯¦ç»†çš„é”™è¯¯æ—¥å¿—** - ä¾¿äºå¼€å‘è€…è°ƒè¯•å’Œæ’æŸ¥é—®é¢˜
4. âœ… **ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼** - å‰ç«¯å¯ä»¥ç»Ÿä¸€å¤„ç†
5. âœ… **é”™è¯¯ç±»å‹è¯†åˆ«** - æ ¹æ®ä¸åŒé”™è¯¯ç±»å‹æä¾›é’ˆå¯¹æ€§å»ºè®®

**ç”¨æˆ·ä½“éªŒæå‡**: ä»æŠ€æœ¯åŒ–çš„ "502 Bad Gateway" åˆ°å‹å¥½çš„ "æ•°æ®åº“æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"

**å¼€å‘è€…æ•ˆç‡æå‡**: è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œå †æ ˆè·Ÿè¸ªï¼Œå¿«é€Ÿå®šä½é—®é¢˜æ ¹æº

---

**Git Commit**: 
```bash
feat: æ”¹è¿›å…¨å±€é”™è¯¯å¤„ç†æœºåˆ¶

- æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶ (errorHandler)
- æ”¹å–„æ‰€æœ‰ API è·¯ç”±çš„é”™è¯¯å“åº”
- æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
- ç»Ÿä¸€é”™è¯¯ä¿¡æ¯æ ¼å¼ï¼ˆä¸­æ–‡å‹å¥½æç¤ºï¼‰
- ä¿®å¤ 502 Bad Gateway ç­‰é”™è¯¯çš„ç”¨æˆ·ä½“éªŒ
```

**ä¸‹ä¸€æ­¥**: å»ºè®®å¯¹å…¶ä»–è·¯ç”±ä¹Ÿè¿›è¡Œç±»ä¼¼çš„é”™è¯¯å¤„ç†æ”¹è¿›ï¼Œå¹¶è€ƒè™‘é›†æˆé”™è¯¯ç›‘æ§æœåŠ¡ã€‚
