# 购物车功能测试指南

本指南详细说明如何测试购物车和支付功能，包括升级和续费场景。

## 📋 测试环境

### 开发环境
- **URL**: https://3000-i1l7k2pbfdion8sxilbu1-6532622b.e2b.dev
- **PayPal 模式**: 沙盒（需配置凭证）

### 生产环境
- **URL**: https://5d10a8dc.review-system.pages.dev
- **PayPal 模式**: 沙盒或生产（根据配置）

## 🧪 测试场景

### 场景 1: 免费用户升级到高级用户

**测试账号**:
- 邮箱: `user@review.com`
- 密码: `user123`
- 角色: `user` (免费用户)

**测试步骤**:

1. **登录系统**
   - 访问系统首页
   - 使用测试账号登录
   - 验证：登录成功，显示用户名和 `user` 角色标签

2. **查看用户设置**
   - 点击导航栏的用户名
   - 进入用户设置页面
   - 验证：显示"免费用户"级别，"永久"有效期，"升级"按钮

3. **添加升级服务到购物车**
   - 点击"升级"按钮
   - 验证：显示"已添加到购物车"通知（绿色）
   - 验证：购物车图标显示数量徽章 `1`

4. **查看购物车**
   - 点击导航栏的购物车图标
   - 验证：购物车模态框打开
   - 验证：显示 1 个商品：
     - 商品名称: "升级服务" / "Upgrade Service"
     - 价格: $20.00 (或配置的价格)
     - 天数: 365 天
   - 验证：显示总价 $20.00

5. **测试重复添加（应该失败）**
   - 关闭购物车模态框
   - 再次点击"升级"按钮
   - 验证：显示"该商品已在购物车中"通知（蓝色信息提示）
   - 验证：购物车徽章仍然显示 `1`

6. **删除商品**
   - 打开购物车
   - 点击商品旁边的"删除"按钮
   - 验证：商品从购物车移除
   - 验证：显示"购物车是空的"提示
   - 验证：购物车徽章消失

7. **重新添加并测试清空功能**
   - 再次点击"升级"按钮添加商品
   - 打开购物车
   - 点击"清空购物车"按钮
   - 验证：所有商品被移除
   - 验证：购物车徽章消失

8. **添加商品并结算（需要 PayPal 配置）**
   - 再次点击"升级"按钮添加商品
   - 打开购物车
   - 点击"结算"按钮
   - 验证：结算模态框打开
   - 验证：显示商品列表和总价
   - 验证：PayPal 按钮显示
   - **如果已配置 PayPal**: 
     - 点击 PayPal 按钮
     - 使用测试账号完成支付
     - 验证：支付成功后显示成功通知
     - 验证：页面刷新，用户角色变为 `premium`
     - 验证：显示订阅到期日期（365天后）
     - 验证：购物车被清空

---

### 场景 2: 高级用户续费订阅

**测试账号**:
- 邮箱: `premium@review.com`
- 密码: `premium123`
- 角色: `premium` (高级用户)

**测试步骤**:

1. **登录系统**
   - 使用高级用户账号登录
   - 验证：显示 `premium` 角色标签

2. **查看用户设置**
   - 点击用户名进入设置页面
   - 验证：显示"高级用户"级别
   - 验证：显示到期日期和剩余天数
   - 验证：显示"续费"按钮（绿色）

3. **添加续费服务到购物车**
   - 点击"续费"按钮
   - 验证：显示"已添加到购物车"通知
   - 验证：购物车徽章显示 `1`

4. **查看购物车**
   - 点击购物车图标
   - 验证：显示 1 个商品：
     - 商品名称: "续费服务" / "Renewal Service"
     - 价格: $18.00 (续费价格，如果配置了 renewal_price)
     - 天数: 365 天

5. **测试重复添加**
   - 再次点击"续费"按钮
   - 验证：显示"该商品已在购物车中"通知
   - 验证：购物车徽章仍然显示 `1`

---

### 场景 3: 多商品购物车测试

**目的**: 测试购物车可以同时包含不同类型的商品（虽然在实际使用中，一个用户通常只会选择升级或续费）

**测试步骤**:

1. **使用免费用户账号登录**
   - 登录 `user@review.com`

2. **添加升级服务**
   - 进入用户设置
   - 点击"升级"按钮
   - 验证：购物车徽章显示 `1`

3. **手动修改用户角色为 premium（仅测试用）**
   - 使用管理员账号登录
   - 进入管理后台 → 用户管理
   - 将 `user@review.com` 的角色改为 `premium`
   - 退出登录，重新用 `user@review.com` 登录

4. **尝试添加续费服务**
   - 进入用户设置（现在应该显示为高级用户）
   - 点击"续费"按钮
   - 验证：由于购物车中已有 `upgrade` 类型商品，现在尝试添加 `renewal` 类型
   - 验证：如果防重复逻辑正确，应该可以添加（因为类型不同）
   - 验证：购物车徽章显示 `2`

5. **查看购物车**
   - 打开购物车
   - 验证：显示 2 个商品
   - 验证：显示正确的总价（两个价格之和）

6. **结算多商品**
   - 点击"结算"按钮
   - 验证：PayPal 订单包含两个商品明细
   - 完成支付
   - 验证：支付成功后购物车清空

**注意**: 实际使用中，用户不会同时添加升级和续费服务，因为：
- 免费用户只能看到"升级"按钮
- 高级用户只能看到"续费"按钮

---

## 🔍 功能验证清单

### 购物车基础功能
- [ ] 购物车图标显示在导航栏
- [ ] 购物车为空时不显示徽章
- [ ] 添加商品后徽章显示正确数量
- [ ] 点击购物车图标打开模态框
- [ ] 购物车模态框显示所有商品
- [ ] 每个商品显示名称、价格、天数
- [ ] 显示正确的总价
- [ ] "删除"按钮可以移除单个商品
- [ ] "清空购物车"按钮可以移除所有商品
- [ ] 购物车为空时显示友好提示

### 升级功能
- [ ] 免费用户设置页面显示"升级"按钮
- [ ] 点击"升级"添加商品到购物车
- [ ] 使用正确的价格（`price`）
- [ ] 商品类型为 `upgrade`
- [ ] 显示成功通知
- [ ] 购物车徽章更新

### 续费功能
- [ ] 高级用户设置页面显示"续费"按钮
- [ ] 点击"续费"添加商品到购物车
- [ ] 使用正确的价格（`renewal_price` 或 `price`）
- [ ] 商品类型为 `renewal`
- [ ] 显示成功通知
- [ ] 购物车徽章更新

### 防重复功能
- [ ] 同一类型商品不能重复添加
- [ ] 重复添加时显示信息提示
- [ ] 购物车数量不变

### PayPal 结算功能
- [ ] "结算"按钮打开结算模态框
- [ ] 结算模态框显示商品明细
- [ ] PayPal 按钮正确显示
- [ ] PayPal 订单包含所有商品
- [ ] 支付成功后更新用户角色
- [ ] 支付成功后设置订阅到期日期
- [ ] 支付成功后清空购物车
- [ ] 支付失败时显示错误提示

### 国际化
- [ ] 中文环境显示中文文本
- [ ] 英文环境显示英文文本
- [ ] 所有购物车相关文本正确翻译
- [ ] 商品描述根据语言显示

---

## 🐛 常见问题排查

### 问题 1: 购物车徽章不显示

**可能原因**:
- JavaScript 错误
- `updateCartCount()` 函数未被调用

**排查步骤**:
1. 打开浏览器开发者工具 (F12)
2. 查看 Console 是否有错误
3. 手动调用 `updateCartCount()` 测试
4. 检查 `/api/cart` 接口是否返回正确数据

### 问题 2: 点击"升级"或"续费"没有反应

**可能原因**:
- API 错误
- 认证失败
- 网络问题

**排查步骤**:
1. 打开 Network 标签
2. 点击按钮
3. 查看 POST `/api/cart` 请求
4. 检查响应状态码和错误信息
5. 查看后端日志: `pm2 logs review-system --nostream`

### 问题 3: PayPal 按钮不显示

**可能原因**:
- PayPal Client ID 未配置
- PayPal SDK 未加载

**排查步骤**:
1. 查看页面源代码，搜索 `paypal.com/sdk`
2. 确认 `client-id` 参数不为空
3. 在 Console 输入 `typeof paypal`，应该返回 `object`
4. 检查 `.dev.vars` 文件中的 `PAYPAL_CLIENT_ID`

### 问题 4: 支付成功但用户未升级

**可能原因**:
- capture-order 端点错误
- 数据库更新失败

**排查步骤**:
1. 查看后端日志
2. 检查 `payment_records` 表
3. 检查 `users` 表的 `role` 和 `subscription_expires_at` 字段
4. 验证 PayPal 订单状态

---

## 📊 数据库验证

### 检查购物车数据

```bash
# 本地开发环境
npx wrangler d1 execute review-system-production --local \
  --command="SELECT * FROM shopping_cart ORDER BY created_at DESC"

# 生产环境
npx wrangler d1 execute review-system-production --remote \
  --command="SELECT * FROM shopping_cart ORDER BY created_at DESC"
```

### 检查支付记录

```bash
# 本地
npx wrangler d1 execute review-system-production --local \
  --command="SELECT * FROM payment_records ORDER BY created_at DESC LIMIT 5"

# 生产
npx wrangler d1 execute review-system-production --remote \
  --command="SELECT * FROM payment_records ORDER BY created_at DESC LIMIT 5"
```

### 检查用户订阅状态

```bash
# 查看特定用户
npx wrangler d1 execute review-system-production --local \
  --command="SELECT id, email, role, subscription_expires_at FROM users WHERE email='user@review.com'"
```

---

## ✅ 测试完成标准

所有测试场景通过，且满足以下条件：

1. **购物车功能**
   - ✅ 可以添加商品
   - ✅ 可以查看商品
   - ✅ 可以删除商品
   - ✅ 可以清空购物车
   - ✅ 徽章正确显示数量

2. **升级功能**
   - ✅ 免费用户可以添加升级服务
   - ✅ 价格正确（使用 `price`）
   - ✅ 商品类型为 `upgrade`

3. **续费功能**
   - ✅ 高级用户可以添加续费服务
   - ✅ 价格正确（使用 `renewal_price`）
   - ✅ 商品类型为 `renewal`

4. **支付流程**
   - ✅ PayPal 按钮正确显示
   - ✅ 可以完成支付（沙盒测试）
   - ✅ 支付成功后用户升级
   - ✅ 购物车自动清空

5. **防重复功能**
   - ✅ 同类型商品不能重复添加
   - ✅ 显示友好的提示信息

6. **国际化**
   - ✅ 中英文切换正常
   - ✅ 所有文本正确翻译

---

**测试完成后，购物车功能即可投入使用！**
