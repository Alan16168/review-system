# V3.4 Bug ä¿®å¤æ€»ç»“

**ä¿®å¤æ—¥æœŸ**: 2025-10-09  
**ä¿®å¤ç‰ˆæœ¬**: V3.4

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šäº†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š
1. **Google ç™»å½•æŒ‰é’®ä¸æ˜¾ç¤º** - åœ¨ç™»å½•/æ³¨å†Œé¡µé¢çœ‹ä¸åˆ° Google è´¦å·ç™»å½•æŒ‰é’®
2. **é‚®ç®±ç™»å½•å¤±è´¥** - ä½¿ç”¨ admin@review.com ç™»å½•æ—¶æç¤º "Invalid credentials"

## ğŸ” é—®é¢˜åˆ†æ

### é—®é¢˜ 1: Google ç™»å½•æŒ‰é’®ä¸æ˜¾ç¤º
**æ ¹æœ¬åŸå› **:
- Google Sign-In JavaScript åº“éœ€è¦æ—¶é—´åŠ è½½
- ä½¿ç”¨é™æ€ HTML `<div class="g_id_signin">` æ–¹å¼ä¾èµ–è‡ªåŠ¨åˆå§‹åŒ–
- é¡µé¢å†…å®¹åŠ¨æ€æ¸²æŸ“åï¼ŒGoogle è„šæœ¬æœªé‡æ–°åˆå§‹åŒ–æŒ‰é’®

**è§£å†³æ–¹æ¡ˆ**:
- æ”¹ç”¨ JavaScript API æ‰‹åŠ¨åˆå§‹åŒ–æŒ‰é’®
- ä½¿ç”¨ `google.accounts.id.initialize()` é…ç½®
- ä½¿ç”¨ `google.accounts.id.renderButton()` æ‰‹åŠ¨æ¸²æŸ“
- åœ¨ `setTimeout` ä¸­å»¶è¿Ÿ 100ms æ‰§è¡Œä»¥ç¡®ä¿ DOM å‡†å¤‡å°±ç»ª

### é—®é¢˜ 2: é‚®ç®±ç™»å½•å¤±è´¥ "Invalid credentials"
**æ ¹æœ¬åŸå› **:
- æ•°æ®åº“é…ç½®é”™è¯¯ï¼š`wrangler.json` ä¸­ `database_name` ä¸º "review-system-production"ï¼Œä½†ä»£ç ä¸­ä½¿ç”¨ "webapp-production"
- æ•°æ®åº“è¿ç§»æœªæ‰§è¡Œ
- ç§å­æ•°æ®æœªå¯¼å…¥

**è§£å†³æ–¹æ¡ˆ**:
1. ä¿®å¤ `wrangler.json` é…ç½®
2. æ‰§è¡Œæ‰€æœ‰æ•°æ®åº“è¿ç§»ï¼ˆ5ä¸ªè¿ç§»æ–‡ä»¶ï¼‰
3. å¯¼å…¥ç§å­æ•°æ®ï¼ˆ3ä¸ªæµ‹è¯•è´¦å·ï¼‰
4. éªŒè¯æ•°æ®åº“è¿æ¥å’ŒæŸ¥è¯¢

## âœ… ä¿®å¤å†…å®¹è¯¦ç»†

### 1. æ•°æ®åº“é…ç½®ä¿®å¤

**ä¿®æ”¹æ–‡ä»¶**: `/home/user/webapp/wrangler.json`

**ä¿®æ”¹å†…å®¹**:
```json
{
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "webapp-production",  // ä» review-system-production æ”¹ä¸º webapp-production
      "database_id": "local"                // æ·»åŠ  database_id
    }
  ]
}
```

**æ‰§è¡Œæ“ä½œ**:
```bash
# åº”ç”¨æ•°æ®åº“è¿ç§»
npx wrangler d1 migrations apply webapp-production --local

# å¯¼å…¥ç§å­æ•°æ®
npx wrangler d1 execute webapp-production --local --file=./seed.sql

# éªŒè¯æ•°æ®
npx wrangler d1 execute webapp-production --local --command="SELECT email, username, role FROM users"
```

**ç»“æœ**:
âœ… 5ä¸ªè¿ç§»æ–‡ä»¶å…¨éƒ¨æˆåŠŸåº”ç”¨  
âœ… 3ä¸ªæµ‹è¯•è´¦å·æˆåŠŸåˆ›å»º  
âœ… æ•°æ®åº“è¡¨ç»“æ„å®Œæ•´

### 2. Google ç™»å½•æŒ‰é’®ä¿®å¤

**ä¿®æ”¹æ–‡ä»¶**: `/home/user/webapp/public/static/app.js`

#### ä¿®æ”¹ 1: showLogin() å‡½æ•°
**åŸä»£ç ** (é™æ€HTMLæ–¹å¼):
```javascript
<div class="mb-6">
  <div id="g_id_onload"
       data-client_id="..."
       data-callback="handleGoogleLogin"
       data-auto_prompt="false">
  </div>
  <div class="g_id_signin"
       data-type="standard"
       data-size="large"
       data-theme="outline"
       data-text="continue_with"
       data-shape="rectangular"
       data-logo_alignment="left"
       data-width="100%">
  </div>
</div>
```

**æ–°ä»£ç ** (JavaScript APIæ–¹å¼):
```javascript
// HTML éƒ¨åˆ† - ç®€åŒ–ä¸ºå®¹å™¨
<div class="mb-6">
  <div id="google-signin-button"></div>
</div>

// JavaScript éƒ¨åˆ† - åœ¨å‡½æ•°æœ«å°¾æ·»åŠ 
setTimeout(() => {
  if (typeof google !== 'undefined' && google.accounts) {
    google.accounts.id.initialize({
      client_id: '78785931273-pse627aasv4h50mcc1cschj5cvtqr88f.apps.googleusercontent.com',
      callback: handleGoogleLogin
    });
    google.accounts.id.renderButton(
      document.getElementById('google-signin-button'),
      { 
        theme: 'outline', 
        size: 'large',
        width: 400,
        text: 'continue_with'
      }
    );
  }
}, 100);
```

#### ä¿®æ”¹ 2: showRegister() å‡½æ•°
åŒæ ·çš„ä¿®æ”¹åº”ç”¨åˆ°æ³¨å†Œé¡µé¢ï¼Œä½¿ç”¨ `google-register-button` ä½œä¸ºå®¹å™¨IDï¼Œ`text: 'signup_with'` ä½œä¸ºæŒ‰é’®æ–‡æ¡ˆã€‚

#### ä¿®æ”¹ 3: handleGoogleLogin() å‡½æ•°
**ä¿®å¤ token å­˜å‚¨ä¸ä¸€è‡´é—®é¢˜**:
```javascript
// åŸä»£ç 
localStorage.setItem('token', result.data.token);

// æ–°ä»£ç  - ä¸é‚®ç®±ç™»å½•ä¿æŒä¸€è‡´
authToken = result.data.token;
currentUser = result.data.user;
localStorage.setItem('authToken', authToken);
localStorage.setItem('user', JSON.stringify(currentUser));
axios.defaults.headers.common['Authorization'] = `Bearer ${authToken}`;
```

### 3. Google API Key é…ç½®

**ä¿®æ”¹æ–‡ä»¶**: `/home/user/webapp/.dev.vars`

**æ·»åŠ å†…å®¹**:
```bash
# Google API Key
GOOGLE_API_KEY=AIzaSyAsXAObY7qWBlnO0aXZYXbInYXfUnbiHKs

# YouTube Data APIï¼ˆä½¿ç”¨ç›¸åŒçš„ API Keyï¼‰
YOUTUBE_API_KEY=AIzaSyAsXAObY7qWBlnO0aXZYXbInYXfUnbiHKs
```

### 4. æ–‡æ¡£æ›´æ–°

**ä¿®æ”¹æ–‡ä»¶**: `/home/user/webapp/README.md`

**æ›´æ–°å†…å®¹**:
- æ·»åŠ  `POST /api/auth/google` API æ–‡æ¡£
- æ›´æ–°éƒ¨ç½²çŠ¶æ€ï¼šGoogle API å·²é…ç½® âœ…
- æ›´æ–°ç‰ˆæœ¬å·ï¼šV3.3 â†’ V3.4
- æ·»åŠ  V3.4 æ›´æ–°æ—¥å¿—

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯• 1: é‚®ç®±ç™»å½•
```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@review.com","password":"admin123"}'
```

**ç»“æœ**: âœ… æˆåŠŸè¿”å› token å’Œç”¨æˆ·ä¿¡æ¯

### æµ‹è¯• 2: æœåŠ¡å¯åŠ¨
```bash
pm2 restart review-system
curl http://localhost:3000
```

**ç»“æœ**: âœ… æœåŠ¡æ­£å¸¸è¿è¡Œï¼ŒHTML é¡µé¢æ­£ç¡®è¿”å›

### æµ‹è¯• 3: æ•°æ®åº“æŸ¥è¯¢
```bash
npx wrangler d1 execute webapp-production --local \
  --command="SELECT email, username, role FROM users"
```

**ç»“æœ**: âœ… æˆåŠŸè¿”å› 3 ä¸ªæµ‹è¯•è´¦å·

## ğŸ“Š æµ‹è¯•è´¦å·

| è§’è‰² | é‚®ç®± | å¯†ç  | çŠ¶æ€ |
|------|------|------|------|
| ç®¡ç†å‘˜ | admin@review.com | admin123 | âœ… å¯ç”¨ |
| é«˜çº§ç”¨æˆ· | premium@review.com | premium123 | âœ… å¯ç”¨ |
| æ™®é€šç”¨æˆ· | user@review.com | user123 | âœ… å¯ç”¨ |

## ğŸŒ è®¿é—®åœ°å€

**åº”ç”¨ URL**: https://3000-i1l7k2pbfdion8sxilbu1-6532622b.e2b.dev

### æµ‹è¯•æ­¥éª¤

1. **æµ‹è¯• Google ç™»å½•æŒ‰é’®æ˜¾ç¤º**:
   - è®¿é—®åº”ç”¨é¦–é¡µ
   - ç‚¹å‡» "å¼€å§‹å¤ç›˜" æˆ– "ç™»å½•"
   - âœ… åº”è¯¥èƒ½çœ‹åˆ° Google ç™»å½•æŒ‰é’®ï¼ˆè“è‰²è¾¹æ¡†ï¼Œå¸¦ Google å›¾æ ‡ï¼‰

2. **æµ‹è¯•é‚®ç®±ç™»å½•**:
   - ç‚¹å‡» "æˆ–" ä¸‹æ–¹çš„é‚®ç®±å¯†ç è¡¨å•
   - è¾“å…¥: admin@review.com / admin123
   - âœ… åº”è¯¥æˆåŠŸç™»å½•å¹¶è·³è½¬åˆ°ä»ªè¡¨æ¿

3. **æµ‹è¯• Google ç™»å½•**ï¼ˆå¯é€‰ï¼‰:
   - ç‚¹å‡» Google ç™»å½•æŒ‰é’®
   - é€‰æ‹© Google è´¦å·
   - âœ… åº”è¯¥è‡ªåŠ¨åˆ›å»ºè´¦å·æˆ–å…³è”ç°æœ‰è´¦å·å¹¶ç™»å½•

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### Google Sign-In åˆå§‹åŒ–é¡ºåº
1. HTML é¡µé¢åŠ è½½ `<script src="https://accounts.google.com/gsi/client" async defer></script>`
2. ç­‰å¾…è„šæœ¬åŠ è½½å®Œæˆï¼ˆ`google` å¯¹è±¡å¯ç”¨ï¼‰
3. è°ƒç”¨ `google.accounts.id.initialize()` é…ç½®
4. è°ƒç”¨ `google.accounts.id.renderButton()` æ¸²æŸ“æŒ‰é’®

### D1 æ•°æ®åº“æœ€ä½³å®è·µ
1. ä½¿ç”¨ `--local` æ ‡å¿—è¿›è¡Œæœ¬åœ°å¼€å‘
2. æ•°æ®åº“åç§°å¿…é¡»åœ¨ `wrangler.json` ä¸­æ­£ç¡®é…ç½®
3. è¿ç§»æ–‡ä»¶å¿…é¡»æŒ‰é¡ºåºç¼–å·ï¼ˆ0001, 0002, ...ï¼‰
4. ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çœŸå®çš„ `database_id`

### Token å­˜å‚¨ä¸€è‡´æ€§
- ä½¿ç”¨ `authToken` ä½œä¸ºå…¨å±€å˜é‡å
- ä½¿ç”¨ `localStorage.setItem('authToken', token)` å­˜å‚¨
- ä½¿ç”¨ `axios.defaults.headers.common['Authorization']` è®¾ç½®è¯·æ±‚å¤´
- Google ç™»å½•å’Œé‚®ç®±ç™»å½•ä½¿ç”¨ç›¸åŒçš„å­˜å‚¨æ–¹å¼

## ğŸš€ éƒ¨ç½²æ£€æŸ¥æ¸…å•

âœ… æ•°æ®åº“é…ç½®æ­£ç¡®  
âœ… æ•°æ®åº“è¿ç§»å·²åº”ç”¨  
âœ… ç§å­æ•°æ®å·²å¯¼å…¥  
âœ… Google OAuth é…ç½®å®Œæˆ  
âœ… Google API Key é…ç½®å®Œæˆ  
âœ… å‰ç«¯ä»£ç å·²æ„å»º  
âœ… æœåŠ¡æ­£å¸¸è¿è¡Œ  
âœ… æ–‡æ¡£å·²æ›´æ–°  

## ğŸ”® åç»­æ”¹è¿›å»ºè®®

1. **Google ç™»å½•ä¼˜åŒ–**:
   - æ·»åŠ åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨
   - å¤„ç† Google è„šæœ¬åŠ è½½å¤±è´¥çš„æƒ…å†µ
   - æ·»åŠ æ›´å‹å¥½çš„é”™è¯¯æç¤º

2. **æ•°æ®åº“ç®¡ç†**:
   - æ·»åŠ æ•°æ®åº“å¤‡ä»½è„šæœ¬
   - å®ç°æ•°æ®åº“é‡ç½®å‘½ä»¤
   - æ·»åŠ æ•°æ®éªŒè¯è„šæœ¬

3. **æµ‹è¯•è¦†ç›–**:
   - æ·»åŠ å•å…ƒæµ‹è¯•
   - æ·»åŠ é›†æˆæµ‹è¯•
   - æ·»åŠ  E2E æµ‹è¯•

---

**ä¿®å¤äºº**: Claude AI Assistant  
**ä¿®å¤æ—¶é—´**: 2025-10-09  
**ç‰ˆæœ¬**: V3.4
