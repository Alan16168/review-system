# 答案组删除功能 - 修复说明

## 修复日期
2025-11-27

## 问题描述
用户需要在答案组管理界面添加"删除"功能键，用于删除当前答案组。特别要求：
1. 在"创建新答案组"和"解锁"键之间增加"删除"功能键
2. 如果是单一的答案组（非多答案组），需要提示用户："这是单一的答案复盘是否确定删除"
3. 用户确定后，才执行删除操作

## 根本原因
答案组管理界面缺少删除功能，用户无法删除不需要的答案组。

## 解决方案

### 1. 前端UI修改 (`public/static/app.js`)

#### 1.1 添加删除按钮
在答案组管理区域的按钮行中，在"创建新答案组"和"锁定/解锁"按钮之间添加"删除"按钮：

```javascript
<!-- Action Buttons Row: Create New Answer Set + Delete + Lock/Unlock Current Set -->
<div class="flex gap-3 mb-4">
  ${review.allow_multiple_answers === 'yes' ? `
    <!-- Create New Answer Set Button -->
    <button type="button" 
            onclick="createNewAnswerSet(${id})"
            class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-lg transition-colors">
      <i class="fas fa-plus-circle mr-2"></i>${i18n.t('createNewSet')}
    </button>
  ` : ''}
  
  <!-- Delete Current Answer Set Button (Always visible) -->
  <button type="button" 
          id="delete-answer-set-btn"
          onclick="deleteCurrentAnswerSet(${id})"
          class="${review.allow_multiple_answers === 'yes' ? '' : 'flex-1'} px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-lg transition-colors disabled:opacity-50"
          disabled>
    <i class="fas fa-trash-alt mr-2"></i>${i18n.t('delete') || '删除'}
  </button>
  
  <!-- Lock/Unlock Current Answer Set Button -->
  <button type="button" 
          id="toggle-answer-set-lock-btn"
          onclick="toggleCurrentAnswerSetLock(${id})"
          class="${review.allow_multiple_answers === 'yes' ? '' : 'flex-1'} px-6 py-3 bg-gray-400 text-white rounded-lg shadow-lg transition-colors disabled:opacity-50"
          disabled>
    <i id="answer-set-lock-icon" class="fas fa-lock mr-2"></i>
    <span id="answer-set-lock-text">${i18n.t('lock') || '锁定'}</span>
  </button>
</div>
```

**关键点**：
- 删除按钮始终显示（无论是否允许多个答案组）
- 初始状态为禁用（`disabled`）
- 按钮颜色为红色（`bg-red-600`）表示危险操作
- 使用红色背景和垃圾桶图标突出其为删除操作

#### 1.2 更新提示信息
修改锁定/解锁提示文本，增加删除相关说明：

```javascript
<p class="text-xs text-gray-500 mb-4">
  <i class="fas fa-info-circle mr-1"></i>${i18n.t('lockAnswerSetHint') || '锁定/解锁当前显示的答案组。锁定后该答案组不可编辑。删除答案组前请先解锁。'}
</p>
```

#### 1.3 实现删除功能 (`deleteCurrentAnswerSet`)

```javascript
/**
 * Delete current answer set
 * @param {number} reviewId - Review ID
 */
async function deleteCurrentAnswerSet(reviewId) {
  try {
    // 1. 检查是否有答案组
    if (!window.currentAnswerSets || window.currentAnswerSets.length === 0) {
      showNotification(i18n.t('noAnswerSetsToDelete') || '没有答案组可以删除', 'warning');
      return;
    }
    
    const currentIndex = window.currentAnswerSetIndex || 0;
    const currentSet = window.currentAnswerSets[currentIndex];
    
    if (!currentSet) {
      showNotification(i18n.t('cannotFindCurrentSet') || '无法找到当前答案组', 'error');
      return;
    }
    
    // 2. 检查是否已锁定
    if (currentSet.is_locked === 'yes') {
      showNotification(i18n.t('unlockBeforeDelete') || '请先解锁答案组才能删除', 'warning');
      return;
    }
    
    const setNumber = currentSet.set_number;
    const totalSets = window.currentAnswerSets.length;
    const isSingleSet = totalSets === 1;
    const allowMultipleAnswers = window.currentEditReview?.allow_multiple_answers === 'yes';
    
    // 3. 根据不同场景准备确认消息
    let confirmMessage;
    if (isSingleSet && !allowMultipleAnswers) {
      // 场景1: 单一答案组模式（不允许多个答案组）
      confirmMessage = i18n.t('confirmDeleteSingleAnswerSet') || 
        '这是单一的答案复盘，删除后将清空所有答案内容。是否确定删除？';
    } else if (isSingleSet) {
      // 场景2: 多答案组模式下的最后一个答案组
      confirmMessage = i18n.t('confirmDeleteLastAnswerSet') || 
        `这是最后一个答案组，删除后将清空所有答案内容。是否确定删除答案组 ${setNumber}？`;
    } else {
      // 场景3: 多个答案组中的一个
      confirmMessage = i18n.t('confirmDeleteAnswerSet') || 
        `确定要删除答案组 ${setNumber} 吗？此操作不可恢复。`;
    }
    
    // 4. 用户确认
    if (!confirm(confirmMessage)) {
      return;
    }
    
    // 5. 调用删除API
    const response = await axios.delete(`/api/answer-sets/${reviewId}/${setNumber}`, {
      headers: {
        'Authorization': `Bearer ${authToken}`
      }
    });
    
    if (response.data.success) {
      showNotification(
        i18n.t('deleteAnswerSetSuccess') || '答案组删除成功',
        'success'
      );
      
      // 6. 从本地数组中移除已删除的答案组
      window.currentAnswerSets.splice(currentIndex, 1);
      
      // 7. 如果没有答案组了，重新加载复盘以显示空状态
      if (window.currentAnswerSets.length === 0) {
        await loadReviewForEditing(reviewId);
        return;
      }
      
      // 8. 导航到新的当前答案组
      // 如果删除的是最后一个，则显示倒数第二个；否则保持在相同索引
      const newIndex = currentIndex >= window.currentAnswerSets.length 
        ? window.currentAnswerSets.length - 1 
        : currentIndex;
      
      window.currentAnswerSetIndex = newIndex;
      
      // 9. 重新渲染答案组
      renderAnswerSet(reviewId);
      updateAnswerSetNavigation(
        reviewId, 
        newIndex + 1, 
        window.currentAnswerSets.length
      );
    }
  } catch (error) {
    console.error('Delete answer set error:', error);
    showNotification(
      error.response?.data?.error || i18n.t('deleteAnswerSetFailed') || '删除答案组失败',
      'error'
    );
  }
}
```

**功能特点**：
1. **多重验证**：
   - 检查是否有答案组存在
   - 检查答案组是否已锁定（锁定的不能删除）
   
2. **智能提示**：
   - 单一答案组（`allow_multiple_answers='no'`）：显示特定警告
   - 最后一个答案组：显示清空警告
   - 普通删除：显示标准确认

3. **删除后处理**：
   - 如果删除后没有答案组，重新加载复盘数据
   - 如果还有答案组，智能导航到合适的答案组
   - 更新导航显示

#### 1.4 更新锁定按钮逻辑
修改 `updateAnswerSetLockButton` 函数，同时控制删除按钮的启用/禁用状态：

```javascript
function updateAnswerSetLockButton(isLocked) {
  const btn = document.getElementById('toggle-answer-set-lock-btn');
  const icon = document.getElementById('answer-set-lock-icon');
  const text = document.getElementById('answer-set-lock-text');
  const deleteBtn = document.getElementById('delete-answer-set-btn');
  
  if (!btn || !icon || !text) return;
  
  // Enable button (it should always be enabled if there are answer sets)
  btn.disabled = false;
  
  if (isLocked) {
    // Show unlock button (green)
    btn.className = 'px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg shadow-lg transition-colors';
    icon.className = 'fas fa-lock-open mr-2';
    text.textContent = i18n.t('unlock') || '解锁';
    
    // Disable delete button when locked
    if (deleteBtn) {
      deleteBtn.disabled = true;
      deleteBtn.title = i18n.t('unlockToDelete') || '请先解锁答案组才能删除';
    }
  } else {
    // Show lock button (red)
    btn.className = 'px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg shadow-lg transition-colors';
    icon.className = 'fas fa-lock mr-2';
    text.textContent = i18n.t('lock') || '锁定';
    
    // Enable delete button when unlocked
    if (deleteBtn) {
      deleteBtn.disabled = false;
      deleteBtn.title = i18n.t('deleteAnswerSet') || '删除当前答案组';
    }
  }
}
```

**关键点**：
- 答案组锁定时，禁用删除按钮
- 答案组解锁时，启用删除按钮
- 提供清晰的提示信息（`title` 属性）

### 2. 后端API（已存在）
后端已有删除答案组的API：`DELETE /api/answer-sets/:reviewId/:setNumber`

**API功能**：
- 验证答案组是否存在
- 检查答案组是否已锁定（锁定的不能删除）
- 执行删除操作（级联删除相关答案）
- 返回成功/失败响应

位置：`src/routes/answer_sets.ts` (行 347-389)

## 修改的文件
1. `public/static/app.js`
   - 添加删除按钮UI（行 6706-6734）
   - 实现 `deleteCurrentAnswerSet` 函数（行 20489+）
   - 修改 `updateAnswerSetLockButton` 函数（行 20493+）

## 测试步骤

### 测试1: 多答案组模式删除
1. 创建一个允许多个答案组的复盘（`allow_multiple_answers='yes'`）
2. 创建多个答案组（如3个）
3. 解锁第2个答案组
4. 点击"删除"按钮
5. **预期**：
   - 显示确认对话框："确定要删除答案组 2 吗？此操作不可恢复。"
   - 确认后，答案组2被删除
   - 自动显示答案组1或3
   - 导航显示更新（如 "2/2"）

### 测试2: 单一答案组模式删除
1. 创建一个不允许多个答案组的复盘（`allow_multiple_answers='no'`）
2. 只有1个答案组
3. 解锁该答案组
4. 点击"删除"按钮
5. **预期**：
   - 显示特定警告："这是单一的答案复盘，删除后将清空所有答案内容。是否确定删除？"
   - 确认后，答案组被删除
   - 复盘数据重新加载，显示空状态

### 测试3: 删除最后一个答案组
1. 创建一个允许多个答案组的复盘
2. 创建3个答案组，然后删除前2个
3. 解锁最后一个答案组
4. 点击"删除"按钮
5. **预期**：
   - 显示警告："这是最后一个答案组，删除后将清空所有答案内容。是否确定删除答案组 3？"
   - 确认后，答案组被删除
   - 复盘数据重新加载

### 测试4: 尝试删除已锁定的答案组
1. 创建答案组并锁定它
2. 尝试点击"删除"按钮
3. **预期**：
   - 删除按钮为禁用状态（灰色，不可点击）
   - 鼠标悬停显示提示："请先解锁答案组才能删除"

### 测试5: 取消删除操作
1. 解锁任意答案组
2. 点击"删除"按钮
3. 在确认对话框中点击"取消"
4. **预期**：
   - 删除操作不执行
   - 答案组保持不变

## 部署信息
- **测试环境**: https://642630ee.review-system.pages.dev
- **生产环境**: https://review-system.pages.dev
- **GitHub提交**: cd21c11 - "新增: 答案组删除功能，支持单一答案组的确认提示"

## 用户体验改进
1. **清晰的操作流程**：
   - 必须先解锁才能删除（防止误操作）
   - 三种不同场景的确认提示（明确操作后果）
   - 删除后智能导航到合适的答案组

2. **视觉设计**：
   - 红色按钮突出危险操作
   - 垃圾桶图标直观表达删除功能
   - 禁用状态清晰可见

3. **错误处理**：
   - 完整的验证和错误提示
   - 操作失败时显示友好的错误消息
   - 删除后自动处理UI状态

## 注意事项
1. 删除操作不可恢复，用户需要确认
2. 锁定的答案组不能删除，需要先解锁
3. 删除最后一个答案组会清空所有答案内容
4. 单一答案组模式下删除有特殊警告
5. 删除后自动刷新UI，无需手动刷新页面
