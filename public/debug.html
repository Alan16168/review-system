<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review System - è¯Šæ–­å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">
            ğŸ” Review System è¯Šæ–­å·¥å…·
        </h1>

        <div class="space-y-6">
            <!-- Step 1: æ£€æŸ¥Token -->
            <div class="border rounded-lg p-4 bg-blue-50">
                <h2 class="text-xl font-bold mb-3">æ­¥éª¤ 1: æ£€æŸ¥è®¤è¯Token</h2>
                <button onclick="checkToken()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                    æ£€æŸ¥Token
                </button>
                <div id="token-result" class="mt-4"></div>
            </div>

            <!-- Step 2: æµ‹è¯•API -->
            <div class="border rounded-lg p-4 bg-green-50">
                <h2 class="text-xl font-bold mb-3">æ­¥éª¤ 2: æµ‹è¯•APIè¿æ¥</h2>
                <input type="number" id="review-id" placeholder="è¾“å…¥Review ID (ä¾‹å¦‚: 275)" 
                       class="border px-4 py-2 rounded-lg mr-2" value="275">
                <button onclick="testAPI()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                    æµ‹è¯•API
                </button>
                <div id="api-result" class="mt-4"></div>
            </div>

            <!-- Step 3: æ¸…é™¤å¹¶é‡ç½® -->
            <div class="border rounded-lg p-4 bg-yellow-50">
                <h2 class="text-xl font-bold mb-3">æ­¥éª¤ 3: æ¸…é™¤å¹¶é‡ç½®</h2>
                <button onclick="clearAll()" class="bg-yellow-600 text-white px-6 py-2 rounded-lg hover:bg-yellow-700">
                    æ¸…é™¤æ‰€æœ‰æ•°æ®
                </button>
                <div id="clear-result" class="mt-4"></div>
            </div>

            <!-- Step 4: å®Œæ•´æ—¥å¿— -->
            <div class="border rounded-lg p-4 bg-gray-50">
                <h2 class="text-xl font-bold mb-3">å®Œæ•´è¯Šæ–­æ—¥å¿—</h2>
                <pre id="full-log" class="bg-gray-800 text-green-400 p-4 rounded-lg overflow-auto max-h-96 text-sm"></pre>
            </div>
        </div>
    </div>

    <script>
        let logMessages = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            const logLine = `[${timestamp}] ${prefix} ${message}`;
            logMessages.push(logLine);
            document.getElementById('full-log').textContent = logMessages.join('\n');
            console.log(message);
        }

        function checkToken() {
            log('å¼€å§‹æ£€æŸ¥Token...');
            const resultDiv = document.getElementById('token-result');
            
            // Check all possible token storage locations
            const tokenKeys = ['authToken', 'token', 'jwt', 'auth'];
            let foundToken = null;
            let tokenKey = null;

            for (const key of tokenKeys) {
                const token = localStorage.getItem(key);
                if (token) {
                    foundToken = token;
                    tokenKey = key;
                    break;
                }
            }

            if (!foundToken) {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-100 border border-red-400 rounded-lg">
                        <p class="font-bold text-red-800">âŒ æœªæ‰¾åˆ°è®¤è¯Tokenï¼</p>
                        <p class="text-red-700 mt-2">è¯·å…ˆç™»å½•ç³»ç»Ÿè·å–Token</p>
                        <a href="/" class="text-blue-600 underline mt-2 inline-block">è¿”å›ç™»å½•é¡µé¢</a>
                    </div>
                `;
                log('æœªæ‰¾åˆ°Tokenï¼Œç”¨æˆ·éœ€è¦ç™»å½•', 'error');
                return;
            }

            log(`æ‰¾åˆ°Token (key: ${tokenKey})`);
            
            // Parse token payload
            try {
                const parts = foundToken.split('.');
                if (parts.length !== 3) {
                    throw new Error('Tokenæ ¼å¼æ— æ•ˆ');
                }

                const payload = JSON.parse(atob(parts[1]));
                const now = Math.floor(Date.now() / 1000);
                const isExpired = payload.exp && payload.exp < now;

                resultDiv.innerHTML = `
                    <div class="p-4 bg-white border rounded-lg">
                        <p class="font-bold ${isExpired ? 'text-red-800' : 'text-green-800'}">
                            ${isExpired ? 'âŒ Tokenå·²è¿‡æœŸ' : 'âœ… Tokenæœ‰æ•ˆ'}
                        </p>
                        <div class="mt-3 text-sm space-y-1">
                            <p><strong>å­˜å‚¨ä½ç½®:</strong> localStorage.${tokenKey}</p>
                            <p><strong>ç”¨æˆ·ID:</strong> ${payload.id || 'N/A'}</p>
                            <p><strong>ç”¨æˆ·å:</strong> ${payload.username || 'N/A'}</p>
                            <p><strong>é‚®ç®±:</strong> ${payload.email || 'N/A'}</p>
                            <p><strong>è§’è‰²:</strong> ${payload.role || 'N/A'}</p>
                            ${payload.exp ? `
                                <p><strong>è¿‡æœŸæ—¶é—´:</strong> ${new Date(payload.exp * 1000).toLocaleString()}</p>
                                <p><strong>å‰©ä½™æ—¶é—´:</strong> ${isExpired ? 'å·²è¿‡æœŸ' : Math.floor((payload.exp - now) / 3600) + 'å°æ—¶'}</p>
                            ` : ''}
                        </div>
                        <details class="mt-3">
                            <summary class="cursor-pointer text-blue-600">æŸ¥çœ‹å®Œæ•´Token (ç‚¹å‡»å±•å¼€)</summary>
                            <pre class="mt-2 p-2 bg-gray-100 rounded text-xs overflow-auto">${foundToken}</pre>
                        </details>
                    </div>
                `;

                if (isExpired) {
                    log('Tokenå·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•', 'error');
                } else {
                    log(`Tokenæœ‰æ•ˆï¼Œç”¨æˆ·: ${payload.username} (ID: ${payload.id})`, 'success');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-100 border border-red-400 rounded-lg">
                        <p class="font-bold text-red-800">âŒ Tokenè§£æå¤±è´¥</p>
                        <p class="text-red-700 mt-2">${error.message}</p>
                        <p class="text-sm text-gray-600 mt-2">Tokenå¯èƒ½å·²æŸåï¼Œå»ºè®®æ¸…é™¤å¹¶é‡æ–°ç™»å½•</p>
                    </div>
                `;
                log('Tokenè§£æå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function testAPI() {
            log('å¼€å§‹æµ‹è¯•APIè¿æ¥...');
            const resultDiv = document.getElementById('api-result');
            const reviewId = document.getElementById('review-id').value;

            // Get token
            const tokenKeys = ['authToken', 'token', 'jwt', 'auth'];
            let token = null;
            for (const key of tokenKeys) {
                token = localStorage.getItem(key);
                if (token) break;
            }

            if (!token) {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-100 border border-red-400 rounded-lg">
                        <p class="font-bold text-red-800">âŒ æœªæ‰¾åˆ°Token</p>
                        <p class="text-red-700 mt-2">è¯·å…ˆæ‰§è¡Œ"æ­¥éª¤1: æ£€æŸ¥è®¤è¯Token"</p>
                    </div>
                `;
                log('æµ‹è¯•APIå¤±è´¥: æœªæ‰¾åˆ°Token', 'error');
                return;
            }

            resultDiv.innerHTML = `
                <div class="p-4 bg-blue-100 border border-blue-400 rounded-lg">
                    <p class="font-bold text-blue-800">ğŸ”„ æ­£åœ¨æµ‹è¯•API...</p>
                    <p class="text-blue-700 mt-2">è¯·æ±‚: GET /api/reviews/${reviewId}</p>
                </div>
            `;

            log(`å‘é€APIè¯·æ±‚: GET /api/reviews/${reviewId}`);

            try {
                const response = await fetch(`/api/reviews/${reviewId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                log(`APIå“åº”çŠ¶æ€: ${response.status}`);

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="p-4 bg-green-100 border border-green-400 rounded-lg">
                            <p class="font-bold text-green-800">âœ… APIè¿æ¥æˆåŠŸï¼</p>
                            <div class="mt-3 text-sm">
                                <p><strong>çŠ¶æ€ç :</strong> ${response.status}</p>
                                <p><strong>Reviewæ ‡é¢˜:</strong> ${data.review?.title || 'N/A'}</p>
                                <p><strong>é—®é¢˜æ•°é‡:</strong> ${data.questions?.length || 0}</p>
                                <p><strong>ç­”æ¡ˆé›†:</strong> ${Object.keys(data.answersByQuestion || {}).length}</p>
                            </div>
                            <details class="mt-3">
                                <summary class="cursor-pointer text-blue-600">æŸ¥çœ‹å®Œæ•´å“åº”</summary>
                                <pre class="mt-2 p-2 bg-gray-100 rounded text-xs overflow-auto max-h-64">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                    log('APIæµ‹è¯•æˆåŠŸ', 'success');
                } else {
                    resultDiv.innerHTML = `
                        <div class="p-4 bg-red-100 border border-red-400 rounded-lg">
                            <p class="font-bold text-red-800">âŒ APIè¿”å›é”™è¯¯</p>
                            <div class="mt-3 text-sm">
                                <p><strong>çŠ¶æ€ç :</strong> ${response.status}</p>
                                <p><strong>é”™è¯¯ä¿¡æ¯:</strong> ${data.error || 'Unknown error'}</p>
                                ${data.details ? `<p><strong>è¯¦ç»†ä¿¡æ¯:</strong> ${data.details}</p>` : ''}
                            </div>
                            <details class="mt-3">
                                <summary class="cursor-pointer text-blue-600">æŸ¥çœ‹å®Œæ•´å“åº”</summary>
                                <pre class="mt-2 p-2 bg-gray-100 rounded text-xs overflow-auto">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                    log(`APIè¿”å›é”™è¯¯ ${response.status}: ${data.error}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-100 border border-red-400 rounded-lg">
                        <p class="font-bold text-red-800">âŒ è¯·æ±‚å¤±è´¥</p>
                        <p class="text-red-700 mt-2">${error.message}</p>
                        <p class="text-sm text-gray-600 mt-2">å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æœåŠ¡å™¨æ— å“åº”</p>
                    </div>
                `;
                log('APIè¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        function clearAll() {
            log('å¼€å§‹æ¸…é™¤æ‰€æœ‰æ•°æ®...');
            const resultDiv = document.getElementById('clear-result');
            
            const beforeCount = localStorage.length;
            localStorage.clear();
            sessionStorage.clear();
            const afterCount = localStorage.length;

            resultDiv.innerHTML = `
                <div class="p-4 bg-green-100 border border-green-400 rounded-lg">
                    <p class="font-bold text-green-800">âœ… æ¸…é™¤å®Œæˆ</p>
                    <p class="text-green-700 mt-2">å·²æ¸…é™¤ ${beforeCount} ä¸ªlocalStorageé¡¹ç›®</p>
                    <p class="text-green-700">å·²æ¸…é™¤æ‰€æœ‰sessionStorageæ•°æ®</p>
                    <a href="/" class="inline-block mt-3 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        è¿”å›ç™»å½•é¡µé¢
                    </a>
                </div>
            `;
            log(`æ¸…é™¤å®Œæˆ: ${beforeCount}ä¸ªlocalStorageé¡¹ç›®`, 'success');
        }

        // Auto-run on page load
        window.addEventListener('load', () => {
            log('=== Review System è¯Šæ–­å·¥å…·å¯åŠ¨ ===');
            log('å½“å‰URL: ' + window.location.href);
            log('User Agent: ' + navigator.userAgent);
            checkToken();
        });
    </script>
</body>
</html>
