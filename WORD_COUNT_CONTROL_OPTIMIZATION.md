# AI 生成内容字数控制优化

## 问题描述

之前的 AI 生成系统在控制字数方面存在问题：
- 设定目标字数为 1000 字
- 实际生成字数为 2080 字
- 超出目标字数 108%（超标 1080 字）

这会导致：
1. 内容冗长，不符合用户预期
2. 增加阅读负担
3. 影响整体书籍结构规划
4. 消耗更多 AI Token，增加成本

## 根本原因

原有 Prompt 中的字数控制不够严格：
```
请为这个小节生成约${targetWords}字的详细内容。
```

问题：
- "约"字过于宽松，AI 理解为可以有较大浮动
- 没有明确字数浮动范围
- 没有强调字数控制的优先级
- 没有说明字数计算规则

## 解决方案

### 1. 严格的字数要求

**优化前：**
```
请为这个小节生成约${targetWords}字的详细内容。
```

**优化后：**
```
⚠️ 字数要求：必须严格控制在 ${targetWords} 字左右（上下浮动不超过10%，即${Math.floor(targetWords * 0.9)}-${Math.ceil(targetWords * 1.1)}字）
```

改进点：
- 使用警告符号 ⚠️ 引起注意
- 明确"必须严格控制"
- 给出具体的浮动范围（±10%）
- 计算并显示具体的字数区间

### 2. 明确字数控制优先级

在内容要求中增加：
```
8. **字数控制优先级最高**：如果内容过长，请精简；如果过短，请适当扩展
```

这告诉 AI：
- 字数控制是第一优先级
- 内容质量与字数控制需要平衡
- 提供了处理字数偏差的指导

### 3. 详细的字数计算规则

添加字数计算说明：
```
字数计算规则：
- 中文字符：每个汉字算1个字
- 英文单词：每个单词算1个字
- 标点符号和空格不计入字数
```

这确保 AI 理解：
- 字数统计标准与系统一致
- 避免因统计方式不同导致的误差

### 4. 自检要求

在 Prompt 末尾添加：
```
请直接输出内容，不要JSON格式，不要前言后语。生成完成后请自己检查字数是否符合要求。
```

这促使 AI：
- 生成后自我检查字数
- 如有偏差及时调整

## 实施范围

已优化以下三个生成端点：

### 1. 小节内容生成 (POST /api/ai-generation/content)
- **文件**: `src/routes/ai_generation.ts`
- **行数**: 437-469
- **默认字数**: 1000 字
- **允许范围**: 900-1100 字 (±10%)

### 2. 前言生成 (POST /api/ai-generation/preface)
- **文件**: `src/routes/ai_generation.ts`
- **行数**: 582-607
- **默认字数**: 500 字
- **允许范围**: 450-550 字 (±10%)

### 3. 后记生成 (POST /api/ai-generation/afterword)
- **文件**: `src/routes/ai_generation.ts`
- **行数**: 688-713
- **默认字数**: 300 字
- **允许范围**: 270-330 字 (±10%)

## 优化后的完整 Prompt 示例

```typescript
const prompt = `你是一位专业的内容创作者。

书籍主题：${section.book_title}
主题描述：${section.book_description || '无'}

章节：第${section.chapter_number}章 - ${section.chapter_title}
章节描述：${section.chapter_description || '无'}

当前小节：${section.section_number}. ${section.title}
小节描述：${section.description || '无'}

⚠️ 字数要求：必须严格控制在 ${targetWords} 字左右（上下浮动不超过10%，即${Math.floor(targetWords * 0.9)}-${Math.ceil(targetWords * 1.1)}字）

内容要求：
1. 内容要专业、准确、有深度
2. 语言风格：${section.tone}
3. 目标读者：${section.audience}
4. 内容要围绕小节主题深入展开
5. 可以包含案例、数据、分析、示例等
6. 使用Markdown格式，包含适当的段落、标题、列表等
7. 内容要有条理性和可读性
8. **字数控制优先级最高**：如果内容过长，请精简；如果过短，请适当扩展

字数计算规则：
- 中文字符：每个汉字算1个字
- 英文单词：每个单词算1个字
- 标点符号和空格不计入字数

请直接输出内容，不要JSON格式，不要前言后语。生成完成后请自己检查字数是否符合要求。`
```

## 预期效果

### 字数控制精度

| 目标字数 | 允许范围 | 说明 |
|---------|---------|------|
| 300 字  | 270-330 字 | 后记 |
| 500 字  | 450-550 字 | 前言 |
| 1000 字 | 900-1100 字 | 小节内容 |
| 自定义  | ±10% | 用户自定义字数 |

### 改进效果

1. **字数精确度提升**
   - 之前：可能超标 50%-100%
   - 优化后：控制在 ±10% 范围内

2. **用户体验改善**
   - 生成内容更符合预期
   - 书籍结构规划更准确
   - 字数统计更可靠

3. **成本控制**
   - 减少不必要的 Token 消耗
   - 提高 AI 生成效率

4. **内容质量**
   - 更加精炼
   - 避免冗长和重复
   - 更好的信息密度

## 测试建议

### 测试场景 1：标准字数（1000字）
1. 创建新书并生成章节
2. 为某个小节生成内容（使用默认 1000 字）
3. 检查实际字数是否在 900-1100 字范围内

### 测试场景 2：自定义字数（500字）
1. 选择某个小节
2. 设置目标字数为 500 字
3. 生成内容
4. 检查实际字数是否在 450-550 字范围内

### 测试场景 3：前言和后记
1. 生成前言（默认 500 字）
2. 生成后记（默认 300 字）
3. 分别检查字数是否在允许范围内

### 验证指标

- ✅ 95% 以上的生成内容字数在 ±10% 范围内
- ✅ 内容质量保持不变或提升
- ✅ 用户满意度提高
- ✅ Token 消耗减少

## 未来优化方向

1. **动态调整**
   - 根据内容复杂度自动调整字数范围
   - 对不同类型内容使用不同的浮动比例

2. **智能建议**
   - 根据章节主题推荐合适的字数
   - 提供字数分配建议

3. **多轮优化**
   - 如果首次生成字数偏差大，自动重试
   - 逐步调整直到满足要求

4. **用户反馈**
   - 收集用户对字数控制的反馈
   - 根据反馈持续优化算法

## 技术细节

### 字数统计函数

```typescript
function calculateWordCount(text: string): number {
  if (!text) return 0
  const cleanText = text.replace(/\s+/g, '')
  const chineseChars = cleanText.match(/[\u4e00-\u9fa5]/g)
  const chineseCount = chineseChars ? chineseChars.length : 0
  const nonChineseText = cleanText.replace(/[\u4e00-\u9fa5]/g, '')
  const englishWords = nonChineseText.split(/[^a-zA-Z0-9]+/).filter(w => w.length > 0)
  return chineseCount + englishWords.length
}
```

### 字数范围计算

```typescript
const minWords = Math.floor(targetWords * 0.9)  // 下限：目标字数的 90%
const maxWords = Math.ceil(targetWords * 1.1)   // 上限：目标字数的 110%
```

## 部署信息

- **提交哈希**: 0bf9b93
- **更新时间**: 2025-11-20
- **影响范围**: AI 内容生成功能
- **向后兼容**: 是（仅优化 Prompt，不影响 API 接口）

## 相关文件

- `src/routes/ai_generation.ts` - AI 生成主文件
- `WORD_COUNT_CONTROL_OPTIMIZATION.md` - 本文档
