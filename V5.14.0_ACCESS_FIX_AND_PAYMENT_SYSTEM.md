# V5.14.0 - å›¢é˜Ÿå¤ç›˜è®¿é—®ä¿®å¤ + å®Œæ•´PayPalä»˜è´¹ç³»ç»Ÿ

## ğŸ“… æ›´æ–°æ—¥æœŸ
2025-11-09

## ğŸ¯ æ›´æ–°ç›®æ ‡
1. **ä¿®å¤å›¢é˜Ÿæˆå‘˜è®¿é—®å›¢é˜Ÿå¤ç›˜æ—¶çš„"access denied"é”™è¯¯**
2. **åˆ›å»ºå®Œæ•´çš„ç”¨æˆ·çº§åˆ«ç®¡ç†å’ŒPayPalä»˜è´¹å‡çº§/ç»­è´¹ç³»ç»Ÿ**

---

## âœ… å®Œæˆçš„æ›´æ–°

### 1. ä¿®å¤å›¢é˜Ÿå¤ç›˜è®¿é—®æƒé™ âœ…

#### é—®é¢˜è¯Šæ–­ï¼š

**åŸé—®é¢˜**ï¼š
- å›¢é˜Ÿæˆå‘˜åœ¨"æˆ‘çš„å¤ç›˜"åˆ—è¡¨ä¸­å¯ä»¥çœ‹åˆ°å›¢é˜Ÿçš„å¤ç›˜
- ä½†ç‚¹å‡»"æŸ¥çœ‹"ã€"ç¼–è¾‘"ã€"æ‰“å°"æ—¶å‡ºç°ï¼š**"æ“ä½œå¤±è´¥: Review not found or access denied"**

**è¡¨ç°åœºæ™¯**ï¼š
```
ç”¨æˆ·Aï¼ˆé˜Ÿé•¿ï¼‰åˆ›å»ºå›¢é˜ŸT1
ç”¨æˆ·Bï¼ˆé˜Ÿå‘˜ï¼‰åŠ å…¥å›¢é˜ŸT1
ç”¨æˆ·Aåœ¨å›¢é˜ŸT1ä¸­åˆ›å»ºå¤ç›˜R1

ç”¨æˆ·Bè§†è§’ï¼š
1. è¿›å…¥"æˆ‘çš„å¤ç›˜" â†’ âœ… çœ‹åˆ°å¤ç›˜R1
2. ç‚¹å‡»"æŸ¥çœ‹" â†’ âŒ é”™è¯¯ï¼šReview not found or access denied
3. ç‚¹å‡»"ç¼–è¾‘" â†’ âŒ é”™è¯¯ï¼šReview not found or access denied
4. ç‚¹å‡»"æ‰“å°" â†’ âŒ é”™è¯¯ï¼šReview not found or access denied
```

**æ ¹æœ¬åŸå› **ï¼š

æŸ¥çœ‹ `src/routes/reviews.ts` ä¸­ GET /:id ç«¯ç‚¹çš„ä»£ç ï¼š

```sql
-- V5.13.0 çš„æŸ¥è¯¢ï¼ˆæœ‰é—®é¢˜ï¼‰
WHERE r.id = ? AND (
  (r.owner_type = 'private' AND r.user_id = ?)
  OR (r.owner_type = 'team' AND EXISTS (...))  -- âŒ åªæ£€æŸ¥owner_type='team'
  OR (r.owner_type = 'public')
  OR EXISTS (SELECT 1 FROM review_collaborators ...)
)
```

**é—®é¢˜**ï¼š
- GET /api/reviews åœ¨ V5.13.0 ä¸­å·²ç»ä¿®å¤ï¼ˆåŒ…å«æ‰€æœ‰æœ‰team_idçš„å¤ç›˜ï¼‰
- ä½† GET /api/reviews/:id ä»ç„¶ä½¿ç”¨æ—§é€»è¾‘ï¼ŒåªåŒ…å« `owner_type='team'`
- å¯¼è‡´å›¢é˜Ÿåˆ›å»ºçš„å¤ç›˜å¦‚æœ owner_type ä¸æ˜¯ 'team'ï¼Œå°±æ— æ³•è®¿é—®è¯¦æƒ…

#### è§£å†³æ–¹æ¡ˆï¼š

**ä¿®å¤åçš„æŸ¥è¯¢é€»è¾‘**ï¼ˆV5.14.0ï¼‰ï¼š
```sql
WHERE r.id = ? AND (
  r.user_id = ?  -- âœ… åˆ›å»ºè€…å¯ä»¥è®¿é—®
  OR (r.team_id IS NOT NULL AND EXISTS (  -- âœ… å›¢é˜Ÿæˆå‘˜å¯ä»¥è®¿é—®
    SELECT 1 FROM team_members 
    WHERE team_id = r.team_id AND user_id = ?
  ))
  OR (r.owner_type = 'public')  -- âœ… å…¬å¼€å¤ç›˜ä»»ä½•äººå¯è®¿é—®
  OR EXISTS (  -- âœ… åä½œè€…å¯ä»¥è®¿é—®
    SELECT 1 FROM review_collaborators 
    WHERE review_id = r.id AND user_id = ?
  )
)
```

**å…³é”®æ”¹è¿›**ï¼š
1. âœ… ç§»é™¤å¯¹ `owner_type='team'` çš„é™åˆ¶
2. âœ… åªæ£€æŸ¥ `team_id IS NOT NULL` + ç”¨æˆ·æ˜¯å›¢é˜Ÿæˆå‘˜
3. âœ… ä¸ GET /api/reviews çš„é€»è¾‘ä¿æŒä¸€è‡´
4. âœ… æƒé™åˆ¤æ–­ç»Ÿä¸€æ¸…æ™°

#### ä¿®å¤æ–‡ä»¶ï¼š
- **src/routes/reviews.ts** (è¡Œ 141-155)
  - GET /:id ç«¯ç‚¹çš„WHEREæ¡ä»¶

#### ä¿®å¤æ•ˆæœï¼š

**ä¿®å¤å‰**ï¼š
| æ“ä½œ | ç»“æœ |
|------|------|
| åˆ—è¡¨ä¸­çœ‹åˆ°å›¢é˜Ÿå¤ç›˜ | âœ… æ˜¾ç¤º |
| ç‚¹å‡»æŸ¥çœ‹ | âŒ Access Denied |
| ç‚¹å‡»ç¼–è¾‘ | âŒ Access Denied |
| ç‚¹å‡»æ‰“å° | âŒ Access Denied |

**ä¿®å¤å**ï¼š
| æ“ä½œ | ç»“æœ |
|------|------|
| åˆ—è¡¨ä¸­çœ‹åˆ°å›¢é˜Ÿå¤ç›˜ | âœ… æ˜¾ç¤º |
| ç‚¹å‡»æŸ¥çœ‹ | âœ… æˆåŠŸæŸ¥çœ‹ |
| ç‚¹å‡»ç¼–è¾‘ | âœ… æˆåŠŸç¼–è¾‘ |
| ç‚¹å‡»æ‰“å° | âœ… æˆåŠŸæ‰“å° |

---

### 2. å®Œæ•´çš„ç”¨æˆ·çº§åˆ«ç®¡ç†ç³»ç»Ÿ âœ…

#### ç³»ç»Ÿè®¾è®¡ï¼š

**ä½ç½®**ï¼šç”¨æˆ·è®¾ç½®é¡µé¢ï¼ˆç‚¹å‡»å¯¼èˆªæ ç”¨æˆ·åè¿›å…¥ï¼‰

**æ˜¾ç¤ºå¯¹è±¡**ï¼š
- âœ… role='user' (å…è´¹ç”¨æˆ·)
- âœ… role='premium' (é«˜çº§ç”¨æˆ·)
- âŒ role='admin' (ç®¡ç†å‘˜ - ä¸æ˜¾ç¤º)

#### A. å…è´¹ç”¨æˆ· (role='user') ç•Œé¢ï¼š

```
ç”¨æˆ·çº§åˆ«ç®¡ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å½“å‰çº§åˆ«          â”‚  æœ‰æ•ˆæœŸ      â”‚  æ“ä½œ             â”‚
â”‚  ğŸ‘¤ å…è´¹ç”¨æˆ·       â”‚  æ°¸ä¹…        â”‚  [å‡çº§] (ç´«è‰²)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ˜¾ç¤ºå†…å®¹**ï¼š
- **å½“å‰çº§åˆ«**: "å…è´¹ç”¨æˆ·" + ç°è‰²ç”¨æˆ·å›¾æ ‡
- **æœ‰æ•ˆæœŸ**: "æ°¸ä¹…" (Forever)
- **æŒ‰é’®**: "å‡çº§" (ç´«è‰²æ¸å˜)

**ç‚¹å‡»å‡çº§æŒ‰é’®**ï¼š
```
å‡çº§åˆ°é«˜çº§ç”¨æˆ·
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘‘ å‡çº§åˆ°é«˜çº§ç”¨æˆ·        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä»·æ ¼ï¼š$20               â”‚
â”‚  æœŸé™ï¼š365å¤©             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ“ åˆ›å»ºå›¢é˜Ÿ              â”‚
â”‚  âœ“ é‚€è¯·æˆå‘˜              â”‚
â”‚  âœ“ å›¢é˜Ÿåä½œå¤ç›˜          â”‚
â”‚  âœ“ åˆ›å»ºè‡ªå®šä¹‰æ¨¡æ¿        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [PayPalæ”¯ä»˜æŒ‰é’®]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### B. é«˜çº§ç”¨æˆ· (role='premium') ç•Œé¢ï¼š

```
ç”¨æˆ·çº§åˆ«ç®¡ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å½“å‰çº§åˆ«          â”‚  æœ‰æ•ˆæœŸ              â”‚  æ“ä½œ        â”‚
â”‚  ğŸ‘‘ é«˜çº§ç”¨æˆ·       â”‚  2025-12-09         â”‚  [ç»­è´¹]     â”‚
â”‚                   â”‚  å‰©ä½™å¤©æ•°: 365å¤©     â”‚  (ç»¿è‰²)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ˜¾ç¤ºå†…å®¹**ï¼š
- **å½“å‰çº§åˆ«**: "é«˜çº§ç”¨æˆ·" + é‡‘è‰²Crownå›¾æ ‡
- **æœ‰æ•ˆæœŸ**: å…·ä½“åˆ°æœŸæ—¥æœŸï¼ˆå¦‚ï¼š2025-12-09ï¼‰
- **å‰©ä½™å¤©æ•°**: åŠ¨æ€è®¡ç®—ï¼ˆå¦‚ï¼šå‰©ä½™å¤©æ•°: 365ï¼‰
- **æŒ‰é’®**: "ç»­è´¹" (ç»¿è‰²æ¸å˜)

**ç‚¹å‡»ç»­è´¹æŒ‰é’®**ï¼š
```
ç»­è´¹è®¢é˜…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”„ ç»­è´¹è®¢é˜…             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â„¹ï¸ å½“å‰åˆ°æœŸæ—¥æœŸ:        â”‚
â”‚     2025-12-09          â”‚
â”‚  ç»­è´¹å°†å»¶é•¿365å¤©æœ‰æ•ˆæœŸ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä»·æ ¼ï¼š$20               â”‚
â”‚  æœŸé™ï¼š365å¤©             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [PayPalæ”¯ä»˜æŒ‰é’®]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®ç°ç»†èŠ‚ï¼š

**1. å‰ç«¯UI** (public/static/app.js)ï¼š

```javascript
// ç”¨æˆ·çº§åˆ«ç®¡ç†sectionï¼ˆç®¡ç†å‘˜ä¸æ˜¾ç¤ºï¼‰
${settings.role !== 'admin' ? `
<div class="mt-8">
  <h3 class="text-xl font-semibold text-gray-700 mb-4 pb-2 border-b border-gray-200">
    <i class="fas fa-star text-yellow-500 mr-2"></i>ç”¨æˆ·çº§åˆ«ç®¡ç†
  </h3>
  
  <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border-2 border-indigo-200">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- å½“å‰çº§åˆ« -->
      <div>
        <p class="text-sm text-gray-600 mb-1">å½“å‰çº§åˆ«</p>
        <p class="text-2xl font-bold ${settings.role === 'premium' ? 'text-yellow-600' : 'text-gray-700'}">
          <i class="fas ${settings.role === 'premium' ? 'fa-crown' : 'fa-user-circle'} mr-2"></i>
          ${settings.role === 'premium' ? 'é«˜çº§ç”¨æˆ·' : 'å…è´¹ç”¨æˆ·'}
        </p>
      </div>
      
      <!-- æœ‰æ•ˆæœŸ -->
      <div>
        <p class="text-sm text-gray-600 mb-1">æœ‰æ•ˆæœŸ</p>
        <p class="text-xl font-semibold text-gray-800">
          ${settings.role === 'premium' && settings.subscription_expires_at 
            ? new Date(settings.subscription_expires_at).toLocaleDateString() 
            : 'æ°¸ä¹…'}
        </p>
        ${settings.role === 'premium' && settings.subscription_expires_at ? `
          <p class="text-xs text-gray-500 mt-1">
            å‰©ä½™å¤©æ•°: ${Math.ceil((new Date(settings.subscription_expires_at) - new Date()) / 86400000)}
          </p>
        ` : ''}
      </div>
      
      <!-- æ“ä½œæŒ‰é’® -->
      <div class="flex items-center justify-end">
        <button onclick="showUpgradeModal()">
          ${settings.role === 'premium' ? 'ç»­è´¹' : 'å‡çº§'}
        </button>
      </div>
    </div>
  </div>
</div>
` : ''}
```

**2. PayPalæ”¯ä»˜æ¨¡æ€æ¡†** (public/static/app.js)ï¼š

```javascript
async function showUpgradeModal() {
  // è·å–ç”¨æˆ·ä¿¡æ¯å’Œé…ç½®
  const [userResponse, configResponse] = await Promise.all([
    axios.get('/api/auth/settings'),
    axios.get('/api/payment/subscription/info')
  ]);
  
  const user = userResponse.data;
  const { premium } = configResponse.data;
  const isRenewal = user.role === 'premium';  // åˆ¤æ–­æ˜¯å‡çº§è¿˜æ˜¯ç»­è´¹
  
  // æ˜¾ç¤ºæ¨¡æ€æ¡†
  // æ ‡é¢˜ï¼šå‡çº§åˆ°é«˜çº§ç”¨æˆ· / ç»­è´¹è®¢é˜…
  // ä»·æ ¼ï¼š$premium.price (é»˜è®¤$20ï¼Œç®¡ç†å‘˜å¯é…ç½®)
  // æœŸé™ï¼š365å¤©
  // PayPalæŒ‰é’®
  
  // æ”¯ä»˜æˆåŠŸåï¼š
  // - æ›´æ–°ç”¨æˆ·çº§åˆ« role='premium'
  // - è®¾ç½®åˆ°æœŸæ—¥æœŸ subscription_expires_at
  // - åˆ·æ–°é¡µé¢æ˜¾ç¤ºæ–°çŠ¶æ€
}
```

**3. å›½é™…åŒ–ç¿»è¯‘** (public/static/i18n.js)ï¼š

**ä¸­æ–‡**ï¼š
```javascript
'userLevelManagement': 'ç”¨æˆ·çº§åˆ«ç®¡ç†',
'currentLevel': 'å½“å‰çº§åˆ«',
'forever': 'æ°¸ä¹…',
'daysRemaining': 'å‰©ä½™å¤©æ•°',
'expired': 'å·²è¿‡æœŸ',
'renew': 'ç»­è´¹',
'currentExpiryDate': 'å½“å‰åˆ°æœŸæ—¥æœŸ',
'renewalExtendsBy365Days': 'ç»­è´¹å°†å»¶é•¿365å¤©æœ‰æ•ˆæœŸ',
'per365Days': '365å¤©',
'createTeams': 'åˆ›å»ºå›¢é˜Ÿ',
'inviteMembers': 'é‚€è¯·æˆå‘˜',
'teamCollaboration': 'å›¢é˜Ÿåä½œå¤ç›˜',
'createCustomTemplates': 'åˆ›å»ºè‡ªå®šä¹‰æ¨¡æ¿',
```

**è‹±æ–‡**ï¼š
```javascript
'userLevelManagement': 'User Level Management',
'currentLevel': 'Current Level',
'forever': 'Forever',
'daysRemaining': 'Days Remaining',
'expired': 'Expired',
'renew': 'Renew',
'currentExpiryDate': 'Current Expiry Date',
'renewalExtendsBy365Days': 'Renewal extends subscription by 365 days',
'per365Days': '365 Days',
'createTeams': 'Create Teams',
'inviteMembers': 'Invite Members',
'teamCollaboration': 'Team Collaboration',
'createCustomTemplates': 'Create Custom Templates',
```

#### æ”¯ä»˜æµç¨‹ï¼š

```
ç”¨æˆ·ç‚¹å‡»"å‡çº§"/"ç»­è´¹"æŒ‰é’®
    â†“
è°ƒç”¨showUpgradeModal()
    â†“
è·å–ç”¨æˆ·ä¿¡æ¯å’Œä»·æ ¼é…ç½®
    â†“
æ˜¾ç¤ºPayPalæ”¯ä»˜æ¨¡æ€æ¡†
  â”œâ”€ æ ‡é¢˜ï¼šå‡çº§åˆ°é«˜çº§ç”¨æˆ· / ç»­è´¹è®¢é˜…
  â”œâ”€ ä»·æ ¼ï¼š$20 (å¯é…ç½®)
  â”œâ”€ æœŸé™ï¼š365å¤©
  â””â”€ PayPalæŒ‰é’®
    â†“
ç”¨æˆ·ç‚¹å‡»PayPalæŒ‰é’®
    â†“
PayPalæ”¯ä»˜æµç¨‹
  â”œâ”€ createOrder: POST /api/payment/subscription/create-order
  â”œâ”€ ç”¨æˆ·åœ¨PayPalé¡µé¢å®Œæˆæ”¯ä»˜
  â””â”€ onApprove: POST /api/payment/subscription/capture-order
    â†“
åç«¯å¤„ç†æ”¯ä»˜
  â”œâ”€ éªŒè¯æ”¯ä»˜
  â”œâ”€ æ›´æ–°ç”¨æˆ·: role='premium'
  â”œâ”€ è®¾ç½®åˆ°æœŸæ—¥æœŸ: subscription_expires_at = ä»Šå¤© + 365å¤©
  â””â”€ è¿”å›æˆåŠŸ
    â†“
å‰ç«¯æ˜¾ç¤º"æ”¯ä»˜æˆåŠŸ"
    â†“
1.5ç§’ååˆ·æ–°é¡µé¢
    â†“
ç”¨æˆ·çœ‹åˆ°æ–°çš„çº§åˆ«å’Œåˆ°æœŸæ—¥æœŸ âœ…
```

#### ç®¡ç†å‘˜é…ç½®ï¼š

ç®¡ç†å‘˜å¯ä»¥åœ¨"ç®¡ç†åå°"ä¸­é…ç½®ï¼š
- **é«˜çº§ç”¨æˆ·ä»·æ ¼**: é»˜è®¤$20
- **é«˜çº§ç”¨æˆ·æœŸé™**: é»˜è®¤365å¤©

é…ç½®APIç«¯ç‚¹ï¼ˆå·²å­˜åœ¨ï¼‰ï¼š
- GET /api/admin/subscription/config
- PUT /api/admin/subscription/config/:tier

---

## ğŸ“‚ ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | å…·ä½“å†…å®¹ |
|------|---------|---------|
| `src/routes/reviews.ts` | ä¿®å¤ | ä¿®æ”¹GET /:idçš„WHEREæ¡ä»¶ï¼Œç§»é™¤owner_typeé™åˆ¶ |
| `public/static/app.js` | é‡æ„ | æ›¿æ¢ç”¨æˆ·ç®¡ç†sectionä¸ºç”¨æˆ·çº§åˆ«ç®¡ç† |
| `public/static/app.js` | å¢å¼º | æ›´æ–°showUpgradeModalæ”¯æŒå‡çº§å’Œç»­è´¹ |
| `public/static/app.js` | åˆ é™¤ | åˆ é™¤æ—§çš„handleUpgradeToPremiumå‡½æ•° |
| `public/static/i18n.js` | æ–°å¢ | æ·»åŠ 13ä¸ªç¿»è¯‘é”®ï¼ˆä¸­è‹±æ–‡ï¼‰ |
| `README.md` | æ›´æ–° | æ›´æ–°åˆ°V5.14.0ç‰ˆæœ¬ä¿¡æ¯ |

---

## ğŸš€ éƒ¨ç½²ä¿¡æ¯

### ç”Ÿäº§ç¯å¢ƒ
- **URL**: https://79acc64f.review-system.pages.dev
- **ä¸»åŸŸå**: https://review-system.pages.dev
- **éƒ¨ç½²æ—¶é—´**: 2025-11-09
- **Git Commit**: 0d0ccfb (V5.14.0 core changes)
- **çŠ¶æ€**: âœ… å·²æˆåŠŸéƒ¨ç½²å¹¶éªŒè¯

### Gitæäº¤è®°å½•
```bash
0d0ccfb - V5.14.0: Fix team review access permissions + Complete PayPal upgrade/renewal system
e601b8f - Update README: V5.14.0 documentation
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1: å›¢é˜Ÿæˆå‘˜è®¿é—®å›¢é˜Ÿå¤ç›˜

#### å‰ç½®æ¡ä»¶ï¼š
- ç”¨æˆ·Aåˆ›å»ºå›¢é˜ŸT1
- ç”¨æˆ·Aé‚€è¯·ç”¨æˆ·BåŠ å…¥å›¢é˜ŸT1
- ç”¨æˆ·Aåœ¨å›¢é˜ŸT1ä¸­åˆ›å»ºå¤ç›˜R1

#### æµ‹è¯•æ­¥éª¤ï¼š
1. ç”¨æˆ·Bç™»å½•ç³»ç»Ÿ
2. è¿›å…¥"æˆ‘çš„å¤ç›˜"
3. æ‰¾åˆ°å¤ç›˜R1
4. ç‚¹å‡»"æŸ¥çœ‹"æŒ‰é’®

#### é¢„æœŸç»“æœï¼š
- âœ… æˆåŠŸæ‰“å¼€å¤ç›˜è¯¦æƒ…é¡µé¢
- âœ… æ˜¾ç¤ºå®Œæ•´çš„å¤ç›˜å†…å®¹
- âœ… æ˜¾ç¤º"ç¼–è¾‘"æŒ‰é’®ï¼ˆå›¢é˜Ÿæˆå‘˜æƒé™ï¼‰

#### å®é™…ç»“æœï¼š
âœ… **å…¨éƒ¨é€šè¿‡**

---

### æµ‹è¯•åœºæ™¯ 2: å…è´¹ç”¨æˆ·å‡çº§

#### æµ‹è¯•æ­¥éª¤ï¼š
1. å…è´¹ç”¨æˆ·ç™»å½•
2. è¿›å…¥ç”¨æˆ·è®¾ç½®
3. æŸ¥çœ‹"ç”¨æˆ·çº§åˆ«ç®¡ç†"section

#### é¢„æœŸç»“æœï¼š
- âœ… æ˜¾ç¤º"å½“å‰çº§åˆ«ï¼šå…è´¹ç”¨æˆ·"
- âœ… æ˜¾ç¤º"æœ‰æ•ˆæœŸï¼šæ°¸ä¹…"
- âœ… æ˜¾ç¤º"å‡çº§"æŒ‰é’®ï¼ˆç´«è‰²ï¼‰

#### å®é™…ç»“æœï¼š
âœ… **å…¨éƒ¨é€šè¿‡**

---

### æµ‹è¯•åœºæ™¯ 3: ç‚¹å‡»å‡çº§æŒ‰é’®

#### æµ‹è¯•æ­¥éª¤ï¼š
1. å…è´¹ç”¨æˆ·ç‚¹å‡»"å‡çº§"æŒ‰é’®
2. æŸ¥çœ‹æ¨¡æ€æ¡†å†…å®¹

#### é¢„æœŸç»“æœï¼š
- âœ… æ˜¾ç¤º"å‡çº§åˆ°é«˜çº§ç”¨æˆ·"æ ‡é¢˜
- âœ… æ˜¾ç¤ºä»·æ ¼$20å’ŒæœŸé™365å¤©
- âœ… æ˜¾ç¤ºé«˜çº§åŠŸèƒ½åˆ—è¡¨
- âœ… æ˜¾ç¤ºPayPalæ”¯ä»˜æŒ‰é’®

#### å®é™…ç»“æœï¼š
âœ… **å…¨éƒ¨é€šè¿‡**

---

### æµ‹è¯•åœºæ™¯ 4: é«˜çº§ç”¨æˆ·ç»­è´¹

#### å‰ç½®æ¡ä»¶ï¼š
- ç”¨æˆ·å·²æ˜¯é«˜çº§ç”¨æˆ·ï¼ˆrole='premium'ï¼‰
- æœ‰åˆ°æœŸæ—¥æœŸï¼ˆsubscription_expires_atï¼‰

#### æµ‹è¯•æ­¥éª¤ï¼š
1. é«˜çº§ç”¨æˆ·ç™»å½•
2. è¿›å…¥ç”¨æˆ·è®¾ç½®
3. æŸ¥çœ‹"ç”¨æˆ·çº§åˆ«ç®¡ç†"section

#### é¢„æœŸç»“æœï¼š
- âœ… æ˜¾ç¤º"å½“å‰çº§åˆ«ï¼šé«˜çº§ç”¨æˆ·"ï¼ˆé‡‘è‰²Crownï¼‰
- âœ… æ˜¾ç¤ºå…·ä½“åˆ°æœŸæ—¥æœŸ
- âœ… æ˜¾ç¤ºå‰©ä½™å¤©æ•°
- âœ… æ˜¾ç¤º"ç»­è´¹"æŒ‰é’®ï¼ˆç»¿è‰²ï¼‰

#### å®é™…ç»“æœï¼š
âœ… **å…¨éƒ¨é€šè¿‡**

---

### æµ‹è¯•åœºæ™¯ 5: ç‚¹å‡»ç»­è´¹æŒ‰é’®

#### æµ‹è¯•æ­¥éª¤ï¼š
1. é«˜çº§ç”¨æˆ·ç‚¹å‡»"ç»­è´¹"æŒ‰é’®
2. æŸ¥çœ‹æ¨¡æ€æ¡†å†…å®¹

#### é¢„æœŸç»“æœï¼š
- âœ… æ˜¾ç¤º"ç»­è´¹è®¢é˜…"æ ‡é¢˜
- âœ… æ˜¾ç¤ºå½“å‰åˆ°æœŸæ—¥æœŸ
- âœ… æ˜¾ç¤º"ç»­è´¹å°†å»¶é•¿365å¤©æœ‰æ•ˆæœŸ"
- âœ… æ˜¾ç¤ºä»·æ ¼$20å’ŒæœŸé™365å¤©
- âœ… æ˜¾ç¤ºPayPalæ”¯ä»˜æŒ‰é’®

#### å®é™…ç»“æœï¼š
âœ… **å…¨éƒ¨é€šè¿‡**

---

### æµ‹è¯•åœºæ™¯ 6: ç®¡ç†å‘˜ä¸æ˜¾ç¤ºç”¨æˆ·çº§åˆ«ç®¡ç†

#### æµ‹è¯•æ­¥éª¤ï¼š
1. ç®¡ç†å‘˜ï¼ˆrole='admin'ï¼‰ç™»å½•
2. è¿›å…¥ç”¨æˆ·è®¾ç½®é¡µé¢

#### é¢„æœŸç»“æœï¼š
- âœ… ä¸æ˜¾ç¤º"ç”¨æˆ·çº§åˆ«ç®¡ç†"section
- âœ… åªæ˜¾ç¤ºè´¦å·è®¾ç½®å’Œå¯†ç ç®¡ç†

#### å®é™…ç»“æœï¼š
âœ… **å…¨éƒ¨é€šè¿‡**

---

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”

### GET /api/reviews/:id æŸ¥è¯¢é€»è¾‘å¯¹æ¯”

| ç‰ˆæœ¬ | æŸ¥è¯¢æ¡ä»¶ | å›¢é˜Ÿæˆå‘˜è®¿é—® | ç»“æœ |
|------|---------|-------------|------|
| **V5.13.0** | `owner_type='team' AND team_member` | âŒ éƒ¨åˆ†å¤±è´¥ | Access Denied |
| **V5.14.0** | `team_id IS NOT NULL AND team_member` | âœ… å®Œå…¨æˆåŠŸ | æ­£å¸¸è®¿é—® |

### ç”¨æˆ·çº§åˆ«ç®¡ç†å¯¹æ¯”

| ç‰ˆæœ¬ | role='user' | role='premium' | role='admin' |
|------|------------|----------------|--------------|
| **V5.13.0** | ç®€å•å‡çº§æŒ‰é’® | ä¸æ˜¾ç¤º | ä¸æ˜¾ç¤º |
| **V5.14.0** | å®Œæ•´çº§åˆ«ç®¡ç† + PayPal | å®Œæ•´çº§åˆ«ç®¡ç† + PayPal | ä¸æ˜¾ç¤º |

### ç”¨æˆ·ç•Œé¢å¯¹æ¯”

**V5.13.0**:
```
ç”¨æˆ·ç®¡ç†ï¼ˆä»…role='user'ï¼‰
â”œâ”€â”€ å½“å‰æ–¹æ¡ˆï¼šå…è´¹ç”¨æˆ·
â”œâ”€â”€ åŠŸèƒ½è¯´æ˜
â””â”€â”€ å‡çº§è´¦æˆ·æŒ‰é’®ï¼ˆç‚¹å‡»æ˜¾ç¤ºè”ç³»ç®¡ç†å‘˜ï¼‰
```

**V5.14.0**:
```
ç”¨æˆ·çº§åˆ«ç®¡ç†ï¼ˆrole='user' å’Œ 'premium'ï¼‰
â”œâ”€â”€ å½“å‰çº§åˆ« | æœ‰æ•ˆæœŸ | æ“ä½œ
â”œâ”€â”€ ä¸‰æ ç½‘æ ¼å¸ƒå±€
â”œâ”€â”€ åŠ¨æ€è®¡ç®—å‰©ä½™å¤©æ•°
â””â”€â”€ PayPalç›´æ¥æ”¯ä»˜ï¼ˆå‡çº§/ç»­è´¹ï¼‰
```

---

## âœ… éªŒæ”¶æ ‡å‡†

**æ‰€æœ‰è¦æ±‚å·²100%å®Œæˆ**ï¼š

### è¦æ±‚ 1: ä¿®å¤å›¢é˜Ÿæˆå‘˜è®¿é—®æƒé™
- âœ… å›¢é˜Ÿæˆå‘˜å¯ä»¥æŸ¥çœ‹å›¢é˜Ÿå¤ç›˜è¯¦æƒ…
- âœ… å›¢é˜Ÿæˆå‘˜å¯ä»¥ç¼–è¾‘å›¢é˜Ÿå¤ç›˜
- âœ… å›¢é˜Ÿæˆå‘˜å¯ä»¥æ‰“å°å›¢é˜Ÿå¤ç›˜
- âœ… ä¸å†å‡ºç°"access denied"é”™è¯¯

### è¦æ±‚ 2: ç”¨æˆ·çº§åˆ«ç®¡ç†ç³»ç»Ÿ
- âœ… åŠŸèƒ½åç§°ï¼š"ç”¨æˆ·çº§åˆ«ç®¡ç†"
- âœ… ä½ç½®ï¼šç”¨æˆ·è®¾ç½®é¡µé¢
- âœ… å…è´¹ç”¨æˆ·æ˜¾ç¤ºï¼šå…è´¹ç”¨æˆ· + æ°¸ä¹… + å‡çº§æŒ‰é’®
- âœ… é«˜çº§ç”¨æˆ·æ˜¾ç¤ºï¼šé«˜çº§ç”¨æˆ· + åˆ°æœŸæ—¥æœŸ + ç»­è´¹æŒ‰é’®
- âœ… ç®¡ç†å‘˜ä¸æ˜¾ç¤ºç”¨æˆ·çº§åˆ«ç®¡ç†
- âœ… PayPalæ”¯ä»˜é›†æˆ
- âœ… ä»·æ ¼é»˜è®¤$20ï¼ˆç®¡ç†å‘˜å¯é…ç½®ï¼‰
- âœ… æœŸé™365å¤©
- âœ… ç»­è´¹å»¶é•¿365å¤©
- âœ… ä¸­è‹±åŒè¯­æ”¯æŒ

### éƒ¨ç½²éªŒè¯
- âœ… å·²éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- âœ… Gitæäº¤è®°å½•å®Œæ•´
- âœ… READMEæ–‡æ¡£æ›´æ–°
- âœ… æµ‹è¯•éªŒè¯é€šè¿‡

---

## ğŸ“ åç»­é…ç½®

### PayPalç”Ÿäº§ç¯å¢ƒé…ç½®

**å½“å‰çŠ¶æ€**ï¼šä½¿ç”¨PayPal Sandboxæµ‹è¯•ç¯å¢ƒ

**åˆ‡æ¢åˆ°ç”Ÿäº§ç¯å¢ƒ**ï¼š

1. **è·å–PayPal Live Credentials**ï¼š
   - ç™»å½• https://developer.paypal.com
   - åˆ‡æ¢åˆ° Live ç¯å¢ƒ
   - è·å– Client ID å’Œ Client Secret

2. **é…ç½®Cloudflare Pagesç¯å¢ƒå˜é‡**ï¼š
```bash
npx wrangler pages secret put PAYPAL_MODE --project-name review-system
# è¾“å…¥: live

npx wrangler pages secret put PAYPAL_CLIENT_ID --project-name review-system
# è¾“å…¥: ä½ çš„Live Client ID

npx wrangler pages secret put PAYPAL_CLIENT_SECRET --project-name review-system
# è¾“å…¥: ä½ çš„Live Client Secret
```

3. **æ›´æ–°å‰ç«¯PayPal SDK**ï¼š
   - ä¿®æ”¹ `src/index.tsx` ä¸­çš„ PayPal Client ID
   - ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒçš„ Client ID

4. **æµ‹è¯•æ”¯ä»˜æµç¨‹**ï¼š
   - ä½¿ç”¨çœŸå®PayPalè´¦å·æµ‹è¯•
   - éªŒè¯æ”¯ä»˜æˆåŠŸåç”¨æˆ·çº§åˆ«æ›´æ–°
   - éªŒè¯åˆ°æœŸæ—¥æœŸè®¡ç®—æ­£ç¡®

### ç®¡ç†å‘˜ä»·æ ¼é…ç½®

ç®¡ç†å‘˜å¯ä»¥åœ¨"ç®¡ç†åå°"ä¸­ä¿®æ”¹ä»·æ ¼ï¼š

1. ç™»å½•ç®¡ç†å‘˜è´¦å·
2. è¿›å…¥"ç®¡ç†åå°"
3. æ‰¾åˆ°"è®¢é˜…ç®¡ç†"æˆ–"ä»·æ ¼è®¾ç½®"
4. ä¿®æ”¹"é«˜çº§ç”¨æˆ·ä»·æ ¼"ï¼ˆé»˜è®¤$20ï¼‰
5. ä¿å­˜é…ç½®

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¦‚æœå›¢é˜Ÿæˆå‘˜ä»ç„¶æ— æ³•è®¿é—®å›¢é˜Ÿå¤ç›˜

**æ£€æŸ¥æ­¥éª¤**ï¼š

1. **ç¡®è®¤éƒ¨ç½²ç‰ˆæœ¬**ï¼š
```bash
curl https://review-system.pages.dev | grep V5.14.0
```

2. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**ï¼š
- Ctrl+Shift+Deleteï¼ˆWindowsï¼‰
- Cmd+Shift+Deleteï¼ˆMacï¼‰

3. **æ£€æŸ¥å›¢é˜Ÿæˆå‘˜å…³ç³»**ï¼š
```sql
SELECT * FROM team_members 
WHERE team_id = ? AND user_id = ?;
```

4. **æ£€æŸ¥å¤ç›˜team_id**ï¼š
```sql
SELECT id, title, team_id, user_id, owner_type 
FROM reviews 
WHERE id = ?;
```

### å¦‚æœPayPalæ”¯ä»˜ä¸å·¥ä½œ

**æ£€æŸ¥æ­¥éª¤**ï¼š

1. **ç¡®è®¤ç¯å¢ƒå˜é‡**ï¼š
```bash
npx wrangler pages secret list --project-name review-system
```

2. **æ£€æŸ¥PayPal SDKåŠ è½½**ï¼š
- æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
- Console tab â†’ æ£€æŸ¥æ˜¯å¦æœ‰ `window.paypal` å¯¹è±¡

3. **æ£€æŸ¥APIå“åº”**ï¼š
- Network tab â†’ æ‰¾åˆ° `/api/payment/subscription/create-order` è¯·æ±‚
- æŸ¥çœ‹å“åº”çŠ¶æ€å’Œæ•°æ®

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-09  
**æŠ¥å‘Šç‰ˆæœ¬**: V5.14.0  
**å®ŒæˆçŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆå¹¶éªŒè¯
