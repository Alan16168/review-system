# Prompt 编辑器功能文档

## 功能概述

现在在生成或重新生成小节内容时，系统会弹出一个 **Prompt 编辑器**，让用户可以自定义 AI 生成内容的指令。

这与"生成章节"和"生成小节"的交互方式保持一致，提供更灵活的内容控制。

## 新增功能

### 1. 生成内容时的 Prompt 编辑

**触发时机**: 点击"生成内容"按钮

**交互流程**:
1. 用户点击"生成内容"
2. 弹出字数输入框（默认1000字，范围100-10000字）
3. **弹出 Prompt 编辑器**，显示默认的生成指令
4. 用户可以编辑 Prompt，或直接使用默认
5. 确认后开始生成内容

### 2. 重新生成内容时的 Prompt 编辑

**触发时机**: 点击"重新生成"按钮

**交互流程**:
1. 用户点击"重新生成"
2. **双重确认**警告会覆盖现有内容
3. 弹出字数输入框
4. **弹出 Prompt 编辑器**，显示默认的生成指令
5. 用户可以编辑 Prompt
6. 确认后开始重新生成内容

## Prompt 编辑器界面

### 默认 Prompt 模板

```
你是一位专业的内容创作者。请严格按照字数要求生成内容。

【书籍信息】
书籍主题：${book.title}
主题描述：${book.description}

【章节信息】
章节：${chapter.title}
章节描述：${chapter.description}

【小节信息】
当前小节：${section.title}
小节描述：${section.description}

【核心任务】
请为这个小节生成${targetWords}字左右的完整内容（允许误差±10%，即${minWords}-${maxWords}字）。

【内容要求】
1. ⚠️ 字数控制：生成内容必须在${minWords}-${maxWords}字范围内（不包含markdown标记符号）
2. 专业性：内容要专业、准确、有深度
3. 语言风格：${book.tone || '专业严谨'}
4. 目标读者：${book.audience || '专业人士'}
5. 结构完整：内容必须有完整的开头、正文和结尾，不能突然中断
6. 格式规范：使用Markdown格式，包含适当的小标题、段落、列表、重点标记
7. 内容充实：可以包含案例、数据、分析、对比等

【特别要求】
- ✅ 必须有明确的结论或总结段落
- ✅ 内容要完整，不能戛然而止
- ✅ 如果接近字数上限，要用简洁的方式收尾
- ❌ 不要包含"未完待续"、"下一节将"等字样
- ❌ 不要超出规定字数范围

请直接输出内容（纯文本+Markdown），不要JSON格式，不要前言说明。
```

### 编辑器特性

- ✅ **多行文本框**: 支持编辑长文本
- ✅ **预填充**: 自动填充上下文信息
- ✅ **可取消**: 点击取消不会生成内容
- ✅ **实时预览**: 看到完整的生成指令

## 使用场景

### 场景 1: 标准内容生成

**操作**:
1. 点击"生成内容"
2. 输入字数（如：1000）
3. **直接点击"确定"使用默认 Prompt**
4. 等待生成

**结果**: 生成符合字数要求的标准内容

### 场景 2: 自定义写作风格

**操作**:
1. 点击"生成内容"
2. 输入字数（如：1500）
3. **编辑 Prompt**，修改语言风格：
   ```
   3. 语言风格：轻松幽默，通俗易懂
   ```
4. 确认生成

**结果**: 生成轻松幽默风格的内容

### 场景 3: 增加特定要求

**操作**:
1. 点击"生成内容"
2. 输入字数（如：2000）
3. **编辑 Prompt**，在【内容要求】中添加：
   ```
   8. 必须包含至少3个实际案例
   9. 每个案例要有具体的数据支持
   10. 要引用权威研究或文献
   ```
4. 确认生成

**结果**: 生成包含案例和数据的深度内容

### 场景 4: 调整内容角度

**操作**:
1. 点击"重新生成"（对现有内容不满意）
2. 双重确认覆盖
3. 输入字数（如：1200）
4. **编辑 Prompt**，在【核心任务】后添加：
   ```
   请从实践操作的角度展开，重点说明具体的实施步骤和注意事项。
   每个要点都要给出可操作的建议。
   ```
5. 确认生成

**结果**: 生成更侧重实践操作的内容

### 场景 5: 特定行业定制

**操作**:
1. 点击"生成内容"
2. 输入字数（如：1500）
3. **编辑 Prompt**，修改【目标读者】和添加行业背景：
   ```
   4. 目标读者：互联网公司的产品经理
   
   【行业背景】
   内容要结合互联网行业特点，使用产品经理熟悉的术语和案例。
   重点关注如何在敏捷开发环境中应用这些方法。
   ```
4. 确认生成

**结果**: 生成针对互联网产品经理的专业内容

## 高级技巧

### 技巧 1: 控制内容结构

在 Prompt 中明确指定结构：

```
【内容结构】
1. 引言（100字）：说明主题的重要性
2. 理论基础（300字）：阐述核心概念
3. 实践方法（400字）：详细的操作步骤
4. 案例分析（200字）：1-2个实际案例
5. 总结建议（100字）：关键要点和建议
```

### 技巧 2: 指定写作视角

```
【写作视角】
采用第一人称视角，以资深教练的身份分享经验。
使用"我认为"、"在我的实践中"等表达方式，增强真实感。
```

### 技巧 3: 限制或要求某些内容

```
【内容限制】
- ❌ 不要使用过于学术的术语
- ❌ 避免空泛的理论，要有具体内容
- ✅ 必须包含量化指标或数据
- ✅ 每个观点都要有支撑依据
```

### 技巧 4: 引用特定风格

```
【参考风格】
请参考《高效能人士的七个习惯》的写作风格：
- 清晰的逻辑框架
- 实用的方法论
- 生动的案例故事
- 易于记忆的要点总结
```

### 技巧 5: 调整语气和情感

```
【语气设定】
语气：充满热情和鼓励，但不失专业
情感：传递信心和正能量，激发读者行动
禁止：冷冰冰的说教口吻，过度夸张的表达
```

## 字数控制优化

### 字数范围

**允许误差**: ±10%

| 设定字数 | 实际范围 | 说明 |
|---------|---------|------|
| 500字   | 450-550字 | 适合简短说明 |
| 1000字  | 900-1100字 | 标准小节长度 |
| 1500字  | 1350-1650字 | 详细展开 |
| 2000字  | 1800-2200字 | 深度分析 |

### 字数验证

- ✅ 输入范围：100-10000字
- ✅ 小于100字：提示错误
- ✅ 大于10000字：提示错误
- ✅ 非数字：提示错误

## 完整性保障

### 自动检查机制

系统会自动检查生成的内容是否完整：

1. **字数检查**: 低于目标85%视为不完整
2. **结尾检查**: 检测是否以逗号、冒号等结尾
3. **格式检查**: 检测未闭合的 markdown 标记
4. **列表检查**: 检测是否以列表项突然结束

### 自动补充

如果检测到不完整，系统会：
- 自动生成约200字的结尾段落
- 总结核心要点
- 给出实践建议或展望
- 确保内容完整收尾

## 技术实现

### 前端实现

```javascript
// 生成内容
async generateSectionContent(sectionId) {
  // 1. 获取字数
  const targetWords = prompt('请输入目标字数:', '1000');
  
  // 2. 构建初始 Prompt
  const initialPrompt = `...包含书籍、章节、小节信息...`;
  
  // 3. 显示 Prompt 编辑器
  const finalPrompt = await window.showPromptEditor(
    '编辑生成内容的Prompt', 
    initialPrompt
  );
  
  // 4. 调用 API
  const response = await axios.post(
    `/api/ai-books/${bookId}/sections/${sectionId}/generate-content`,
    { 
      target_word_count: targetWords,
      prompt: finalPrompt  // 发送自定义 Prompt
    }
  );
}
```

### 后端实现

```typescript
app.post('/:id/sections/:sectionId/generate-content', async (c) => {
  const body = await c.req.json();
  const targetWords = body.target_word_count || 1000;
  
  // 使用自定义 Prompt（如果提供）或默认 Prompt
  const prompt = body.prompt || `...默认 Prompt 模板...`;
  
  // 调用 Gemini API
  const content = await callGeminiAPI(apiKey, prompt, maxTokens);
  
  // 检查完整性并自动补充（如果需要）
  // ...
  
  return c.json({ success: true, content, word_count });
});
```

## 安全考虑

### Prompt 注入防护

虽然当前实现没有严格的 Prompt 过滤，但有以下保护措施：

1. **字数限制**: Prompt 长度有上限（由前端文本框限制）
2. **后端验证**: 后端会验证请求的合法性
3. **用户权限**: 只有登录用户可以生成内容
4. **成本控制**: Token 使用受系统设置限制

### 未来改进

1. **Prompt 模板库**: 提供预设的 Prompt 模板
2. **Prompt 验证**: 检测和过滤恶意 Prompt
3. **使用统计**: 记录 Prompt 使用情况
4. **效果评估**: 根据生成质量优化默认 Prompt

## 用户反馈

### 常见问题

**Q1: 为什么我的 Prompt 没有生效？**

A1: 请确保：
- Prompt 清晰明确
- 字数要求合理
- 没有矛盾的指令
- AI 理解你的要求

**Q2: 可以保存常用的 Prompt 吗？**

A2: 当前版本暂不支持，建议：
- 复制到本地文本文件保存
- 使用浏览器的表单自动填充功能
- 未来版本会考虑添加 Prompt 模板库

**Q3: 生成的内容还是不符合要求怎么办？**

A3: 建议：
1. 点击"重新生成"
2. 更详细地描述你的要求
3. 给出具体的例子或参考
4. 使用"编辑"功能手动调整

**Q4: 字数还是超标/不足怎么办？**

A4: 字数控制已优化到 ±10% 范围，如果仍有问题：
- 可能是 Prompt 中的其他要求导致
- 尝试简化 Prompt
- 调整目标字数
- 使用"编辑"功能手动删减/扩充

## 最佳实践总结

1. **首次生成**: 使用默认 Prompt，观察效果
2. **调整优化**: 根据生成结果调整 Prompt
3. **保持简洁**: Prompt 不要过于冗长复杂
4. **明确具体**: 使用具体的要求而非模糊描述
5. **适当示例**: 如有必要，提供示例说明
6. **分步实现**: 复杂内容分多次生成和编辑
7. **人工校对**: 生成后检查并手动优化

---

**更新日期**: 2025-11-20  
**Git Commit**: 6e64237  
**功能状态**: ✅ 已上线  
**用户手册**: 本文档
